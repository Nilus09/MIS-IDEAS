<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mis Ideas - Detalle</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f2ee; --bg2: #ede9e3; --black: #1a1a18; --dark: #2e2e2c;
      --red: #8b1c1c; --mid: #6b6b68; --border: #ccc8c0;
    }
    body {
      background: var(--bg); color: var(--black); font-family: 'Lato', sans-serif;
      font-weight: 300; min-height: 100vh;
    }
    body::before { content:''; display:block; height:3px; background:var(--red); position:fixed; top:0;left:0;right:0; z-index:999; }
    
    .back-nav {
      background: var(--bg2); padding: 12px 40px; border-bottom: 1px solid var(--border);
      position: sticky; top: 3px; z-index: 100;
    }
    .btn-back {
      display: inline-flex; align-items: center; gap: 8px; color: var(--black);
      text-decoration: none; font-size: 0.75rem; font-weight: 700;
      letter-spacing: 0.1em; text-transform: uppercase; padding: 8px 0; transition: color 0.2s;
    }
    .btn-back:hover { color: var(--red); }
    
    article { max-width: 720px; margin: 0 auto; padding: 60px 40px 80px; }
    
    /* ---- AUTOR TOP ---- */
    .author-box-top {
      display: flex; align-items: center; gap: 12px;
      padding: 16px 20px; background: white; border: 1px solid var(--border);
      border-left: 3px solid var(--red); margin-bottom: 36px;
    }
    .author-box-top img {
      width: 42px; height: 42px; border-radius: 50%; object-fit: cover;
      border: 2px solid var(--border); flex-shrink: 0;
    }
    .author-box-top-info {}
    .author-box-top-label {
      font-size: 0.6rem; font-weight: 700; letter-spacing: 0.14em;
      text-transform: uppercase; color: var(--mid); margin-bottom: 2px;
    }
    .author-box-top-name {
      font-size: 0.95rem; font-weight: 700; color: var(--black);
    }
    
    .article-header { margin-bottom: 40px; padding-bottom: 30px; border-bottom: 2px solid var(--black); }
    .article-meta { display: flex; gap: 16px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    .article-category { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.18em; text-transform: uppercase; color: var(--red); }
    .article-date { font-size: 0.7rem; font-weight: 400; color: var(--mid); }
    .article-title { font-family: 'Playfair Display', serif; font-size: 2.2rem; font-weight: 900; line-height: 1.2; color: var(--black); margin-bottom: 20px; }
    .article-tags { display: flex; gap: 8px; flex-wrap: wrap; }
    .tag { font-size: 0.65rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; padding: 4px 10px; background: var(--bg2); color: var(--mid); border: 1px solid var(--border); }
    .article-body { font-size: 1.05rem; line-height: 1.9; color: var(--dark); margin-bottom: 40px; }
    .article-body p { margin-bottom: 1.5em; }
    
    /* ---- AUTOR BOTTOM ---- */
    .author-box-bottom {
      display: flex; align-items: center; gap: 14px;
      padding: 20px 24px; background: white; border: 1px solid var(--border);
      margin: 40px 0; border-top: 3px solid var(--black);
    }
    .author-box-bottom img {
      width: 50px; height: 50px; border-radius: 50%; object-fit: cover;
      border: 2px solid var(--border); flex-shrink: 0;
    }
    .author-box-bottom-info {}
    .author-box-bottom-label {
      font-size: 0.6rem; font-weight: 700; letter-spacing: 0.14em;
      text-transform: uppercase; color: var(--mid); margin-bottom: 3px;
    }
    .author-box-bottom-name { font-size: 1rem; font-weight: 700; color: var(--black); }
    .author-box-bottom-email { font-size: 0.75rem; color: var(--mid); margin-top: 2px; }
    
    /* ---- ARCHIVOS ---- */
    .article-files { margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--border); }
    .files-title { font-size: 0.75rem; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--mid); margin-bottom: 20px; }
    .file-list { display: flex; flex-direction: column; gap: 12px; }
    .file-item {
      display: flex; align-items: center; gap: 12px; padding: 16px;
      background: white; border: 1px solid var(--border); border-left: 3px solid var(--black);
      border-radius: 4px; transition: border-left-color 0.2s, box-shadow 0.2s;
    }
    .file-item:hover { border-left-color: var(--red); box-shadow: 2px 2px 12px rgba(0,0,0,0.08); }
    .file-icon { font-size: 1.5rem; flex-shrink: 0; }
    .file-info { flex: 1; }
    .file-name { font-size: 0.9rem; font-weight: 700; color: var(--black); margin-bottom: 4px; }
    .file-type { font-size: 0.75rem; color: var(--mid); }
    .file-actions { display: flex; gap: 8px; flex-shrink: 0; }
    .btn-view, .btn-download {
      text-decoration: none; padding: 10px 18px; font-size: 0.7rem; font-weight: 700;
      letter-spacing: 0.1em; text-transform: uppercase; border-radius: 4px; transition: all 0.2s;
      white-space: nowrap; cursor: pointer; border: none;
    }
    .btn-view { background: var(--bg2); color: var(--black); border: 1px solid var(--border); }
    .btn-view:hover { background: var(--border); }
    .btn-download { background: var(--black); color: white; }
    .btn-download:hover { background: var(--red); }
    
    /* ---- CHAT SECTION ---- */
    .chat-section {
      margin-top: 60px; padding-top: 40px; border-top: 2px solid var(--black);
    }
    .chat-section-head {
      display: flex; align-items: baseline; justify-content: space-between;
      margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
      position: relative;
    }
    .chat-section-head::before {
      content: ''; position: absolute; bottom: -1px; left: 0;
      width: 28px; height: 1px; background: var(--red);
    }
    .chat-section-head h2 {
      font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; color: var(--black);
    }
    .chat-count { font-size: 0.7rem; color: var(--mid); }
    
    .chat-messages {
      display: flex; flex-direction: column; gap: 0;
      margin-bottom: 24px;
    }
    
    .chat-msg {
      display: flex; gap: 12px; padding: 16px 0;
      border-bottom: 1px solid var(--bg2);
    }
    .chat-msg:last-child { border-bottom: none; }
    
    .chat-msg-avatar {
      width: 34px; height: 34px; border-radius: 50%; object-fit: cover;
      border: 1px solid var(--border); flex-shrink: 0; margin-top: 2px;
    }
    .chat-msg-content { flex: 1; }
    .chat-msg-header { display: flex; gap: 10px; align-items: baseline; margin-bottom: 5px; }
    .chat-msg-name { font-size: 0.85rem; font-weight: 700; color: var(--black); }
    .chat-msg-time { font-size: 0.65rem; color: var(--mid); }
    .chat-msg-text { font-size: 0.92rem; line-height: 1.6; color: var(--dark); }
    
    .chat-empty {
      padding: 30px 20px; text-align: center; color: var(--mid);
      font-style: italic; font-size: 0.85rem; background: white; border: 1px dashed var(--border);
    }
    
    /* Chat input */
    .chat-input-area {
      background: white; border: 1px solid var(--border); padding: 16px;
    }
    .chat-input-row { display: flex; gap: 10px; }
    .chat-input-row img {
      width: 34px; height: 34px; border-radius: 50%; object-fit: cover;
      border: 1px solid var(--border); flex-shrink: 0; align-self: flex-end;
    }
    .chat-input-inner { flex: 1; display: flex; gap: 8px; }
    .chat-input {
      flex: 1; border: 1px solid var(--border); border-bottom-width: 2px;
      background: var(--bg); color: var(--black); font-family: 'Lato', sans-serif;
      font-size: 0.9rem; padding: 10px 14px; outline: none; transition: border-color 0.2s;
      resize: none; min-height: 44px; max-height: 120px;
    }
    .chat-input:focus { border-color: var(--black); border-bottom-color: var(--red); background: white; }
    .btn-send {
      background: var(--black); color: white; border: none; font-family: 'Lato', sans-serif;
      font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
      padding: 10px 20px; cursor: pointer; transition: background 0.2s; align-self: flex-end;
    }
    .btn-send:hover { background: var(--red); }
    .btn-send:disabled { background: var(--mid); cursor: not-allowed; }
    
    .chat-no-access {
      padding: 20px; background: white; border: 1px solid var(--border);
      text-align: center; color: var(--mid); font-size: 0.85rem; line-height: 1.6;
    }
    .chat-no-access strong { display: block; margin-bottom: 4px; color: var(--black); font-size: 0.9rem; }
    
    /* Preview modal */
    .preview-overlay {
      display: none; position: fixed; inset: 0; background: rgba(20,20,18,0.9);
      z-index: 1000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px);
    }
    .preview-overlay.active { display: flex; }
    .preview-container {
      background: white; width: 100%; max-width: 1000px; height: 90vh; border-radius: 8px;
      overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }
    .preview-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 20px; background: var(--bg2); border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    .preview-title { font-size: 0.85rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--black); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80%; }
    .preview-close {
      background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--mid);
      padding: 4px 8px; transition: color 0.2s; min-width: 44px; min-height: 44px;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .preview-close:hover { color: var(--black); }
    .preview-content { flex: 1; overflow: auto; background: var(--bg); -webkit-overflow-scrolling: touch; }
    .preview-content iframe { width: 100%; height: 100%; border: none; display: block; }
    .preview-content img { width: 100%; height: 100%; object-fit: contain; display: block; }
    .preview-not-supported { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px; text-align: center; color: var(--mid); }
    .preview-not-supported .icon { font-size: 4rem; margin-bottom: 20px; }
    
    .loading { text-align: center; padding: 80px 20px; font-size: 1rem; color: var(--mid); }
    .error { text-align: center; padding: 80px 20px; color: var(--red); }
    
    @media(max-width:580px){
      .back-nav{ padding:10px 16px; }
      article{ padding:40px 16px 60px; }
      .article-title{ font-size:1.6rem; }
      .author-box-top, .author-box-bottom{ padding:14px 16px; }
      .author-box-top img{ width:36px; height:36px; }
      .author-box-bottom img{ width:42px; height:42px; }
      .chat-input-row img{ width:28px; height:28px; }
      .preview-overlay{ padding:0; }
      .preview-container{ height:100vh; max-width:100%; border-radius:0; }
      .preview-content{ height:calc(100vh - 50px); overflow:auto; -webkit-overflow-scrolling:touch; }
      .file-item{ flex-wrap:wrap; }
      .file-actions{ width:100%; margin-top:10px; }
      .btn-view, .btn-download{ flex:1; text-align:center; }
    }
  </style>
</head>
<body>

<nav class="back-nav">
  <a href="index.html" class="btn-back">‚Üê Volver al inicio</a>
</nav>

<article id="article">
  <div class="loading">Cargando...</div>
</article>

<div class="preview-overlay" id="previewOverlay" onclick="closePreview(event)">
  <div class="preview-container" onclick="event.stopPropagation()">
    <div class="preview-header">
      <div class="preview-title" id="previewTitle">Vista previa</div>
      <button class="preview-close" onclick="closePreview()">‚úï</button>
    </div>
    <div class="preview-content" id="previewContent"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, doc, getDoc, collection, addDoc, query, orderBy, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD57cIHb-k4bhMwKvoDHp2uOcJw_EDPVxg",
    authDomain: "netnull-a9a18.firebaseapp.com",
    projectId: "netnull-a9a18",
    storageBucket: "netnull-a9a18.firebasestorage.app",
    messagingSenderId: "85420219235",
    appId: "1:85420219235:web:b7a93121caa8519602d156"
  };

  const ADMIN_EMAIL = 'nilelpeque@gmail.com';

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const LABELS = { politica:'Pol√≠tica', sociedad:'Sociedad', economia:'Econom√≠a', cultura:'Cultura', historia:'Historia' };

  let currentUser = null;
  let isAdmin = false;
  let canWrite = false;
  let myDisplayName = '';
  let ideaId = null;
  let chatUnsub = null;

  // ‚Äî‚Äî‚Äî AUTH ‚Äî‚Äî‚Äî
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (user) {
      isAdmin = user.email === ADMIN_EMAIL;
      const userData = await getUserData(user.uid);
      myDisplayName = userData?.displayName || user.displayName || user.email.split('@')[0];
      canWrite = isAdmin || userData?.canWrite === true;
    } else {
      isAdmin = false; canWrite = false; myDisplayName = '';
    }
    // Re-render chat area when auth changes
    renderChatArea();
  });

  async function getUserData(uid) {
    try {
      const snap = await getDoc(doc(db, 'usuarios', uid));
      return snap.exists() ? snap.data() : null;
    } catch { return null; }
  }

  // ‚Äî‚Äî‚Äî LOAD IDEA ‚Äî‚Äî‚Äî
  function getFileIcon(fn) {
    if (!fn) return 'üìÑ';
    const l = fn.toLowerCase();
    if (l.includes('.pdf')) return 'üìï';
    if (l.includes('.doc') || l.includes('.txt')) return 'üìù';
    if (l.includes('.xls') || l.includes('.csv')) return 'üìä';
    if (l.includes('.jpg') || l.includes('.png') || l.includes('.gif')) return 'üñºÔ∏è';
    if (l.includes('.zip') || l.includes('.rar')) return 'üì¶';
    return 'üìÑ';
  }
  function getFileType(fn) {
    if (!fn) return 'other';
    const l = fn.toLowerCase();
    if (l.includes('.pdf')) return 'pdf';
    if (/\.(jpe?g|png|gif|webp)$/.test(l)) return 'image';
    if (/\.(mp4|webm|ogg)$/.test(l)) return 'video';
    return 'other';
  }

  let ideaData = null;

  async function loadIdea() {
    const params = new URLSearchParams(window.location.search);
    ideaId = params.get('id');
    if (!ideaId) { document.getElementById('article').innerHTML = '<div class="error">Idea no encontrada</div>'; return; }

    try {
      const snap = await getDoc(doc(db, "ideas", ideaId));
      if (!snap.exists()) { document.getElementById('article').innerHTML = '<div class="error">Idea no encontrada</div>'; return; }
      ideaData = snap.data();

      const authorName = ideaData.authorName || ideaData.author?.split('@')[0] || 'Autor';
      const authorPhoto = ideaData.authorPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(authorName)}&background=1a1a18&color=f0ede8`;
      const authorEmail = ideaData.author || '';

      const filesHTML = ideaData.files?.length ? `
        <div class="article-files">
          <div class="files-title">üìé Archivos adjuntos</div>
          <div class="file-list">
            ${ideaData.files.map(f => {
              const type = getFileType(f.name || f.url);
              const canView = type !== 'other';
              return `<div class="file-item">
                <div class="file-icon">${getFileIcon(f.name || f.url)}</div>
                <div class="file-info">
                  <div class="file-name">${f.name || 'Archivo'}</div>
                  <div class="file-type">${(f.name || f.url).split('.').pop().toUpperCase()}</div>
                </div>
                <div class="file-actions">
                  ${canView ? `<button class="btn-view" onclick="openPreview('${f.url}','${(f.name||'').replace(/'/g,"\\'")}','${type}')">üëÅÔ∏è Ver</button>` : ''}
                  <a href="${f.url}" target="_blank" class="btn-download">‚¨áÔ∏è Descargar</a>
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>` : '';

      document.getElementById('article').innerHTML = `
        <div class="author-box-top">
          <img src="${authorPhoto}" alt="${authorName}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(authorName)}&background=1a1a18&color=f0ede8'">
          <div class="author-box-top-info">
            <div class="author-box-top-label">Publicado por</div>
            <div class="author-box-top-name">${authorName}</div>
          </div>
        </div>
        
        <header class="article-header">
          <div class="article-meta">
            <span class="article-category">${LABELS[ideaData.section] || ideaData.section}</span>
            <span class="article-date">${ideaData.date}</span>
          </div>
          <h1 class="article-title">${ideaData.idea}</h1>
          ${ideaData.tags?.length ? `<div class="article-tags">${ideaData.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>` : ''}
        </header>
        
        <div class="article-body">${ideaData.body}</div>
        
        ${filesHTML}
        
        <div class="author-box-bottom">
          <img src="${authorPhoto}" alt="${authorName}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(authorName)}&background=1a1a18&color=f0ede8'">
          <div class="author-box-bottom-info">
            <div class="author-box-bottom-label">Escrito por</div>
            <div class="author-box-bottom-name">${authorName}</div>
            <div class="author-box-bottom-email">${authorEmail}</div>
          </div>
        </div>
        
        <div class="chat-section" id="chat-section">
          <div class="chat-section-head">
            <h2>üí¨ Comentarios</h2>
            <span class="chat-count" id="chat-count"></span>
          </div>
          <div class="chat-messages" id="chat-messages">
            <div class="chat-empty">Cargando comentarios...</div>
          </div>
          <div id="chat-input-wrapper"></div>
        </div>
      `;

      document.title = `${ideaData.idea} - Mis Ideas`;
      
      // Start listening chat
      subscribeChat();
      renderChatArea();

    } catch (err) {
      console.error(err);
      document.getElementById('article').innerHTML = '<div class="error">Error al cargar la idea</div>';
    }
  }

  // ‚Äî‚Äî‚Äî CHAT ‚Äî‚Äî‚Äî
  function subscribeChat() {
    if (!ideaId) return;
    if (chatUnsub) chatUnsub();
    const q = query(collection(db, 'ideas', ideaId, 'chat'), orderBy('timestamp', 'asc'));
    chatUnsub = onSnapshot(q, (snap) => {
      const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderMessages(msgs);
      const countEl = document.getElementById('chat-count');
      if (countEl) countEl.textContent = msgs.length ? `${msgs.length} comentario${msgs.length !== 1 ? 's' : ''}` : '';
    }, (err) => {
      console.error('Chat error:', err);
    });
  }

  function renderMessages(msgs) {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    if (msgs.length === 0) {
      container.innerHTML = '<div class="chat-empty">Sin comentarios a√∫n. ¬°S√© el primero!</div>';
      return;
    }
    container.innerHTML = msgs.map(m => {
      const name = m.authorName || m.authorEmail?.split('@')[0] || 'An√≥nimo';
      const photo = m.authorPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=1a1a18&color=f0ede8&size=64`;
      const time = m.timestamp?.toDate ? formatTime(m.timestamp.toDate()) : '';
      return `<div class="chat-msg">
        <img class="chat-msg-avatar" src="${photo}" alt="${name}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=ccc&color=333'">
        <div class="chat-msg-content">
          <div class="chat-msg-header">
            <span class="chat-msg-name">${name}</span>
            <span class="chat-msg-time">${time}</span>
          </div>
          <div class="chat-msg-text">${escapeHtml(m.text)}</div>
        </div>
      </div>`;
    }).join('');
  }

  function renderChatArea() {
    const wrapper = document.getElementById('chat-input-wrapper');
    if (!wrapper) return;

    if (!currentUser) {
      wrapper.innerHTML = `<div class="chat-no-access"><strong>Accede para comentar</strong>Inicia sesi√≥n para participar en la conversaci√≥n.</div>`;
      return;
    }
    if (!canWrite) {
      wrapper.innerHTML = `<div class="chat-no-access"><strong>Sin acceso al chat</strong>El administrador a√∫n no te ha dado permisos para comentar.</div>`;
      return;
    }

    const myPhoto = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(myDisplayName)}&background=1a1a18&color=f0ede8`;
    wrapper.innerHTML = `
      <div class="chat-input-area">
        <div class="chat-input-row">
          <img src="${myPhoto}" alt="T√∫" onerror="this.src='https://ui-avatars.com/api/?name=?&background=ccc&color=333'">
          <div class="chat-input-inner">
            <textarea class="chat-input" id="chat-text" placeholder="Escribe un comentario..." rows="2" onkeydown="handleChatKey(event)"></textarea>
            <button class="btn-send" onclick="sendMsg()" id="btn-send">Enviar</button>
          </div>
        </div>
      </div>
    `;
  }

  window.handleChatKey = function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
  };

  window.sendMsg = async function() {
    if (!canWrite || !currentUser || !ideaId) return;
    const textarea = document.getElementById('chat-text');
    const text = textarea.value.trim();
    if (!text) return;
    const btn = document.getElementById('btn-send');
    btn.disabled = true;
    textarea.disabled = true;
    try {
      await addDoc(collection(db, 'ideas', ideaId, 'chat'), {
        text,
        authorEmail: currentUser.email,
        authorName: myDisplayName,
        authorPhoto: currentUser.photoURL || '',
        timestamp: Timestamp.now()
      });
      textarea.value = '';
    } catch (err) {
      alert('Error al enviar: ' + err.message);
    }
    btn.disabled = false;
    textarea.disabled = false;
    textarea.focus();
  };

  function formatTime(date) {
    const now = new Date();
    const diff = now - date;
    if (diff < 60000) return 'ahora';
    if (diff < 3600000) return `hace ${Math.floor(diff/60000)}m`;
    if (diff < 86400000) return `hace ${Math.floor(diff/3600000)}h`;
    return `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
  }

  function escapeHtml(text) {
    return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  }

  // ‚Äî‚Äî‚Äî FILE PREVIEW ‚Äî‚Äî‚Äî
  window.openPreview = function(url, name, type) {
    const overlay = document.getElementById('previewOverlay');
    const content = document.getElementById('previewContent');
    document.getElementById('previewTitle').textContent = name;
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    if (type === 'image') {
      content.innerHTML = `<img src="${url}" alt="${name}">`;
    } else if (type === 'pdf') {
      const isMobile = window.innerWidth <= 580;
      content.innerHTML = `<iframe src="${url}${isMobile ? '#toolbar=0&navpanes=0&scrollbar=1' : '#toolbar=0'}" title="${name}" style="width:100%;height:100%;min-height:100%;"></iframe>`;
    } else if (type === 'video') {
      content.innerHTML = `<video controls style="width:100%;height:100%;background:#000;"><source src="${url}" type="video/mp4"></video>`;
    } else {
      content.innerHTML = `<div class="preview-not-supported"><div class="icon">üìÑ</div><p>No se puede previsualizar este tipo de archivo.</p><a href="${url}" target="_blank" class="btn-download" style="display:inline-block;">Descargar</a></div>`;
    }
  };

  window.closePreview = function(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('previewOverlay').classList.remove('active');
    document.getElementById('previewContent').innerHTML = '';
    document.body.style.overflow = '';
  };

  document.addEventListener('keydown', e => { if (e.key === 'Escape') closePreview(); });

  loadIdea();
</script>
</body>
</html>
