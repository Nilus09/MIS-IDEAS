<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Ideas</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f2ee; --bg2: #ede9e3; --black: #1a1a18; --dark: #2e2e2c;
      --red: #8b1c1c; --mid: #6b6b68; --border: #ccc8c0;
    }
    body {
      background: var(--bg); color: var(--black); font-family: 'Lato', sans-serif;
      font-weight: 300; min-height: 100vh;
      background-image: url("image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    }
    body::before { content:''; display:block; height:3px; background:var(--red); position:fixed; top:0;left:0;right:0; z-index:999; }
    
    header {
      background:var(--black); padding:38px 40px 34px; display:flex; align-items:center;
      justify-content:space-between; flex-wrap:wrap; gap:16px; margin-top:3px; position:relative;
    }
    header::after { content:''; position:absolute; bottom:0;left:40px;right:40px; height:1px; background:rgba(255,255,255,0.07); }
    
    .site-title { font-family:'Playfair Display',serif; font-size:2rem; font-weight:900; color:#f0ede8; letter-spacing:0.02em; }
    .site-tagline { font-size:0.68rem; font-weight:700; letter-spacing:0.18em; text-transform:uppercase; color:rgba(240,237,232,0.35); margin-top:4px; }
    
    .auth-buttons { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn-login {
      background:#4285f4; color:white; border:none; border-radius:4px;
      font-family:'Lato',sans-serif; font-size:0.78rem; font-weight:700;
      padding:11px 22px; cursor:pointer; display:flex; align-items:center; gap:8px;
      transition:background 0.2s;
    }
    .btn-login:hover { background:#3367d6; }
    .btn-login img { width:18px; height:18px; }
    
    .btn-logout {
      background:transparent; color:rgba(240,237,232,0.7); border:1px solid rgba(255,255,255,0.3);
      font-family:'Lato',sans-serif; font-size:0.7rem; font-weight:700;
      padding:8px 16px; cursor:pointer; border-radius:4px;
      transition:all 0.2s;
    }
    .btn-logout:hover { background:rgba(255,255,255,0.1); color:#f0ede8; }
    
    .user-info { color:rgba(240,237,232,0.8); font-size:0.75rem; margin-right:10px; }
    
    .btn-new {
      background:var(--red); color:#f0ede8; border:none;
      font-family:'Lato',sans-serif; font-size:0.78rem; font-weight:700;
      letter-spacing:0.12em; text-transform:uppercase; padding:11px 22px;
      cursor:pointer; transition:background 0.2s, transform 0.15s;
    }
    .btn-new:hover { background:#a52222; transform:translateY(-1px); }
    .btn-new:active { transform:translateY(0); }
    .btn-new:disabled { background:var(--mid); cursor:not-allowed; transform:none; opacity:0.7; }
    
    nav {
      background:var(--bg2); border-bottom:1px solid var(--border); display:flex;
      flex-wrap:wrap; padding:0 40px; position:sticky; top:3px; z-index:50;
      box-shadow:0 2px 12px rgba(0,0,0,0.06);
    }
    nav a {
      font-size:0.72rem; font-weight:700; letter-spacing:0.15em; text-transform:uppercase;
      color:var(--mid); text-decoration:none; padding:15px 18px; border-bottom:2px solid transparent;
      transition:all 0.2s; position:relative;
    }
    nav a:hover { color:var(--black); }
    nav a.active { color:var(--black); border-bottom-color:var(--red); }
    
    main { max-width:960px; margin:0 auto; padding:54px 24px 90px; }
    .section { margin-bottom:66px; }
    .section-head {
      display:flex; align-items:baseline; justify-content:space-between;
      margin-bottom:26px; padding-bottom:12px; border-bottom:2px solid var(--black); position:relative;
    }
    .section-head::before { content:''; position:absolute; bottom:-2px; left:0; width:28px; height:2px; background:var(--red); }
    .section-head h2 { font-family:'Playfair Display',serif; font-size:1.25rem; font-weight:900; letter-spacing:0.02em; color:var(--black); }
    
    .btn-section-add {
      background:none; border:1px solid var(--border); color:var(--mid);
      font-family:'Lato',sans-serif; font-size:0.68rem; font-weight:700;
      letter-spacing:0.12em; text-transform:uppercase; padding:5px 13px;
      cursor:pointer; transition:all 0.2s;
    }
    .btn-section-add:hover { border-color:var(--black); color:var(--black); }
    .btn-section-add:disabled { opacity:0.5; cursor:not-allowed; display:none; }
    
    .posts-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:14px; }
    
    .card {
      background:white; border:1px solid var(--border); border-top:3px solid var(--black);
      border-left:3px solid transparent; padding:22px 22px 18px; cursor:pointer;
      transition:border-top-color 0.2s, border-left-color 0.2s, box-shadow 0.2s, transform 0.2s; position:relative;
    }
    .card:hover {
      border-top-color:var(--black); border-left-color:var(--red);
      box-shadow:4px 6px 24px rgba(0,0,0,0.09); transform:translateY(-2px) translateX(1px);
    }
    .card-date { font-size:0.65rem; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:var(--mid); margin-bottom:11px; }
    .card-idea { font-family:'Playfair Display',serif; font-size:1rem; font-weight:700; line-height:1.5; color:var(--black); margin-bottom:16px; }
    .card-tags { display:flex; flex-wrap:wrap; gap:5px; margin-bottom:14px; }
    .tag {
      font-size:0.6rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase;
      padding:3px 8px; background:var(--bg2); color:var(--mid); border:1px solid var(--border);
      transition:background 0.15s, color 0.15s;
    }
    .card:hover .tag { background:#e8e4de; }
    .card-actions {
      display:flex; gap:8px; margin-top:12px;
    }
    .btn-edit {
      background:var(--bg2); border:1px solid var(--border); color:var(--black);
      font-family:'Lato',sans-serif; font-size:0.65rem; font-weight:700;
      letter-spacing:0.1em; text-transform:uppercase; padding:6px 12px;
      cursor:pointer; transition:all 0.2s; border-radius:3px;
    }
    .btn-edit:hover { background:var(--border); }
    .card-more {
      font-size:0.7rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:var(--red); opacity:0; transition:opacity 0.2s;
    }
    .card:hover .card-more { opacity:1; }
    .empty { font-size:0.82rem; color:var(--mid); font-style:italic; padding:18px 20px; border:1px dashed var(--border); background:white; }
    
    .overlay {
      display:none; position:fixed; inset:0; background:rgba(20,20,18,0.75);
      z-index:200; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(2px);
    }
    .overlay.open { display:flex; }
    
    .modal {
      background:white; max-width:620px; width:100%; max-height:85vh; overflow-y:auto;
      position:relative; border-top:4px solid var(--red); box-shadow:0 20px 60px rgba(0,0,0,0.25);
      animation:up 0.25s ease;
    }
    .modal-head { padding:30px 32px 22px; border-bottom:1px solid var(--border); }
    .modal-cat { font-size:0.65rem; font-weight:700; letter-spacing:0.18em; text-transform:uppercase; color:var(--red); margin-bottom:10px; }
    .modal-title { font-family:'Playfair Display',serif; font-size:1.45rem; font-weight:700; line-height:1.4; color:var(--black); }
    .modal-body { padding:26px 32px 30px; font-size:0.97rem; line-height:1.85; color:var(--dark); }
    .modal-body p+p { margin-top:1.1em; }
    .modal-foot { padding:14px 32px 18px; border-top:1px solid var(--border); display:flex; flex-wrap:wrap; gap:5px; }
    .modal-close {
      position:absolute; top:14px; right:18px; background:none; border:none;
      font-size:1rem; cursor:pointer; color:var(--mid); transition:color 0.15s;
      line-height:1; padding:4px;
    }
    .modal-close:hover { color:var(--black); }
    
    .files-list {
      margin-top:16px; padding-top:16px; border-top:1px solid var(--border);
    }
    .files-list h4 {
      font-size:0.75rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase;
      color:var(--mid); margin-bottom:10px;
    }
    .file-item {
      display:flex; align-items:center; gap:8px; padding:8px; background:var(--bg);
      border:1px solid var(--border); border-radius:4px; margin-bottom:6px;
    }
    .file-item a {
      color:var(--black); text-decoration:none; font-size:0.85rem; flex:1;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .file-item a:hover { color:var(--red); }
    .file-icon {
      font-size: 1rem;
    }
    
    .form-box {
      background:white; max-width:560px; width:100%; border-top:4px solid var(--black);
      position:relative; box-shadow:0 20px 60px rgba(0,0,0,0.25); animation:up 0.25s ease;
    }
    .form-head { padding:26px 28px 18px; border-bottom:1px solid var(--border); }
    .form-head h2 { font-family:'Playfair Display',serif; font-size:1.1rem; font-weight:700; color:var(--black); }
    .form-body { padding:24px 28px; display:flex; flex-direction:column; gap:18px; }
    .form-group { display:flex; flex-direction:column; gap:7px; }
    .form-group label { font-size:0.65rem; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:var(--mid); }
    .form-group input, .form-group textarea, .form-group select {
      border:1px solid var(--border); border-bottom-width:2px; background:var(--bg);
      color:var(--black); font-family:'Lato',sans-serif; font-size:0.95rem; font-weight:300;
      padding:10px 12px; outline:none; transition:border-color 0.2s, background 0.2s; resize:vertical;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      border-color:var(--black); border-bottom-color:var(--red); background:white;
    }
    .form-group select option { background:white; }
    
    .btn-upload {
      background: var(--bg2);
      border: 2px dashed var(--border);
      padding: 12px 20px;
      text-align: center;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
      font-size: 0.9rem;
      color: var(--black);
    }
    .btn-upload:hover {
      border-color: var(--black);
      background: var(--bg);
    }
    .btn-upload.uploading {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .file-list-preview {
      margin-top: 10px;
    }
    .file-preview-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 5px;
      font-size: 0.85rem;
    }
    .file-preview-item .remove-file {
      cursor: pointer;
      color: var(--red);
      font-weight: bold;
      padding: 0 5px;
    }
    .file-preview-item .remove-file:hover {
      color: var(--black);
    }
    
    .form-foot { padding:14px 28px 24px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid var(--border); }
    
    .btn-cancel {
      background:none; border:1px solid var(--border); color:var(--mid);
      font-family:'Lato',sans-serif; font-size:0.72rem; font-weight:700;
      letter-spacing:0.1em; text-transform:uppercase; padding:9px 18px;
      cursor:pointer; transition:all 0.2s;
    }
    .btn-cancel:hover { border-color:var(--mid); color:var(--black); }
    
    .btn-pub {
      background:var(--black); border:none; color:white;
      font-family:'Lato',sans-serif; font-size:0.72rem; font-weight:700;
      letter-spacing:0.1em; text-transform:uppercase; padding:9px 24px;
      cursor:pointer; transition:background 0.2s;
    }
    .btn-pub:hover { background:var(--red); }
    .btn-pub:disabled { background:var(--mid); cursor:not-allowed; }
    
    .readonly-notice {
      font-size:0.7rem; color:var(--mid); font-style:italic;
      padding:8px 12px; background:var(--bg2); border-left:2px solid var(--border);
      margin-top:8px; display:none;
    }
    .readonly-notice.visible { display:block; }
    
    @keyframes up { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
    
    @media(max-width:580px){
      header{padding:24px 20px; flex-direction:column; align-items:flex-start;}
      .auth-buttons{width:100%; justify-content:flex-end; margin-top:10px;}
      nav{padding:0 10px}
      main{padding:30px 16px 60px}
      .posts-grid{grid-template-columns:1fr}
      .modal-head,.modal-body,.modal-foot{padding-left:20px;padding-right:20px}
    }
  </style>
</head>
<body>

<header>
  <div>
    <div class="site-title">Mis Ideas</div>
    <div class="site-tagline">Cuaderno de pensamiento</div>
  </div>
  <div class="auth-buttons">
    <div id="user-display" style="display:none;">
      <span class="user-info" id="user-email"></span>
      <button class="btn-logout" onclick="logout()">Salir</button>
    </div>
    <button id="btn-login" class="btn-login" onclick="loginWithGoogle()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
      Acceder
    </button>
    <button id="btn-new-idea" class="btn-new" onclick="openForm()" style="display:none;">+ Nueva idea</button>
  </div>
</header>

<nav id="nav">
  <a href="#" onclick="filter(event,'all')" class="active" data-sec="all">Todo</a>
  <a href="#" onclick="filter(event,'politica')" data-sec="politica">Pol√≠tica</a>
  <a href="#" onclick="filter(event,'sociedad')" data-sec="sociedad">Sociedad</a>
  <a href="#" onclick="filter(event,'economia')" data-sec="economia">Econom√≠a</a>
  <a href="#" onclick="filter(event,'cultura')" data-sec="cultura">Cultura</a>
  <a href="#" onclick="filter(event,'historia')" data-sec="historia">Historia</a>
</nav>

<main>
  <div class="section" id="politica">
    <div class="section-head">
      <h2>Pol√≠tica</h2>
      <button class="btn-section-add" onclick="openForm('politica')" id="btn-add-politica">+ A√±adir</button>
    </div>
    <div class="posts-grid" id="grid-politica"></div>
  </div>
  <div class="section" id="sociedad">
    <div class="section-head">
      <h2>Sociedad</h2>
      <button class="btn-section-add" onclick="openForm('sociedad')" id="btn-add-sociedad">+ A√±adir</button>
    </div>
    <div class="posts-grid" id="grid-sociedad"></div>
  </div>
  <div class="section" id="economia">
    <div class="section-head">
      <h2>Econom√≠a</h2>
      <button class="btn-section-add" onclick="openForm('economia')" id="btn-add-economia">+ A√±adir</button>
    </div>
    <div class="posts-grid" id="grid-economia"></div>
  </div>
  <div class="section" id="cultura">
    <div class="section-head">
      <h2>Cultura</h2>
      <button class="btn-section-add" onclick="openForm('cultura')" id="btn-add-cultura">+ A√±adir</button>
    </div>
    <div class="posts-grid" id="grid-cultura"></div>
  </div>
  <div class="section" id="historia">
    <div class="section-head">
      <h2>Historia</h2>
      <button class="btn-section-add" onclick="openForm('historia')" id="btn-add-historia">+ A√±adir</button>
    </div>
    <div class="posts-grid" id="grid-historia"></div>
  </div>
</main>

<div class="overlay" id="read-overlay" onclick="closeIfOutside(event,'read-overlay')">
  <div class="modal">
    <button class="modal-close" onclick="close_('read-overlay')">‚úï</button>
    <div class="modal-head">
      <div class="modal-cat" id="m-cat"></div>
      <div class="modal-title" id="m-title"></div>
    </div>
    <div class="modal-body" id="m-body"></div>
    <div class="modal-foot" id="m-tags"></div>
    <div class="files-list" id="m-files" style="display:none; padding:14px 32px 18px;">
      <h4>üìé Archivos adjuntos</h4>
      <div id="m-files-content"></div>
    </div>
  </div>
</div>

<div class="overlay" id="form-overlay" onclick="closeIfOutside(event,'form-overlay')">
  <div class="form-box">
    <button class="modal-close" onclick="close_('form-overlay')">‚úï</button>
    <div class="form-head"><h2 id="form-title">Nueva idea</h2></div>
    <div class="form-body">
      <div class="form-group">
        <label>Secci√≥n</label>
        <select id="f-sec">
          <option value="politica">Pol√≠tica</option>
          <option value="sociedad">Sociedad</option>
          <option value="economia">Econom√≠a</option>
          <option value="cultura">Cultura</option>
          <option value="historia">Historia</option>
        </select>
      </div>
      <div class="form-group">
        <label>Idea en una frase</label>
        <input id="f-idea" type="text" placeholder="La idea principal...">
      </div>
      <div class="form-group">
        <label>Desarrollo</label>
        <textarea id="f-body" rows="6" placeholder="Escribe tu argumento completo. Separa p√°rrafos con una l√≠nea en blanco."></textarea>
      </div>
      <div class="form-group">
        <label>Etiquetas (separadas por coma)</label>
        <input id="f-tags" type="text" placeholder="naci√≥n, orden, pol√≠tica">
      </div>
      <div class="form-group">
        <label>Archivos adjuntos</label>
        <input type="file" id="f-file-input" multiple style="display:none" onchange="handleFileSelect(event)">
        <div class="btn-upload" onclick="document.getElementById('f-file-input').click()">
          üìé Click para seleccionar archivos
        </div>
        <div class="file-list-preview" id="file-preview"></div>
      </div>
      <div class="readonly-notice" id="readonly-msg">
        ‚ö†Ô∏è Solo <strong>nilelpeque@gmail.com</strong> puede publicar ideas.
      </div>
    </div>
    <div class="form-foot">
      <button class="btn-cancel" onclick="close_('form-overlay')">Cancelar</button>
      <button class="btn-pub" onclick="publish()" id="btn-publish">Publicar</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, Timestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // ============================================
  // üî• FIREBASE CONFIG
  // ============================================
  const firebaseConfig = {
    apiKey: "AIzaSyD57cIHb-k4bhMwKvoDHp2uOcJw_EDPVxg",
    authDomain: "netnull-a9a18.firebaseapp.com",
    projectId: "netnull-a9a18",
    storageBucket: "netnull-a9a18.firebasestorage.app",
    messagingSenderId: "85420219235",
    appId: "1:85420219235:web:b7a93121caa8519602d156"
  };

  // ============================================
  // üóÑÔ∏è SUPABASE CONFIG
  // ============================================
  const supabaseUrl = 'https://epuppytaijalxggsmnhn.supabase.co';
  const supabaseAnonKey = 'sb_publishable_nHDee2p3jhqi1iKsANLXJQ_FHZTqIiv';
  const supabase = createClient(supabaseUrl, supabaseAnonKey);
  const SUPABASE_BUCKET = 'archivos';
  // ============================================

  const AUTHORIZED_EMAIL = 'nilelpeque@gmail.com';

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  let posts = [];
  let currentUser = null;
  let isAuthorized = false;
  let editingId = null;
  let selectedFiles = [];

  const LABELS = { politica:'Pol√≠tica', sociedad:'Sociedad', economia:'Econom√≠a', cultura:'Cultura', historia:'Historia' };
  const SECS = Object.keys(LABELS);

  window.loginWithGoogle = async function() {
    try {
      const result = await signInWithPopup(auth, provider);
      checkAuthorization(result.user);
    } catch (error) {
      console.error("Error login:", error);
      alert("Error: " + error.message);
    }
  };

  window.logout = async function() {
    try {
      await signOut(auth);
      updateUI();
    } catch (error) {
      console.error("Error logout:", error);
    }
  };

  function checkAuthorization(user) {
    if (user && user.email === AUTHORIZED_EMAIL) {
      isAuthorized = true;
      currentUser = user;
    } else {
      isAuthorized = false;
      currentUser = user;
      if (user) alert(`üîê Solo ${AUTHORIZED_EMAIL} puede publicar.`);
    }
    updateUI();
  }

  function updateUI() {
    const btnLogin = document.getElementById('btn-login');
    const btnNewIdea = document.getElementById('btn-new-idea');
    const userDisplay = document.getElementById('user-display');
    const userEmail = document.getElementById('user-email');
    const btnAdd = document.querySelectorAll('.btn-section-add');
    const readonlyMsg = document.getElementById('readonly-msg');
    const btnPublish = document.getElementById('btn-publish');

    if (isAuthorized) {
      btnLogin.style.display = 'none';
      btnNewIdea.style.display = 'inline-block';
      userDisplay.style.display = 'flex';
      userEmail.textContent = currentUser.email;
      btnAdd.forEach(btn => { btn.style.display = 'inline-block'; btn.disabled = false; });
      readonlyMsg.classList.remove('visible');
      btnPublish.disabled = false;
    } else if (currentUser) {
      btnLogin.style.display = 'none';
      btnNewIdea.style.display = 'none';
      userDisplay.style.display = 'flex';
      userEmail.textContent = currentUser.email + ' (solo lectura)';
      btnAdd.forEach(btn => btn.style.display = 'none');
      readonlyMsg.classList.add('visible');
      btnPublish.disabled = true;
    } else {
      btnLogin.style.display = 'inline-block';
      btnNewIdea.style.display = 'none';
      userDisplay.style.display = 'none';
      btnAdd.forEach(btn => btn.style.display = 'none');
      readonlyMsg.classList.add('visible');
      btnPublish.disabled = true;
    }
  }

  onAuthStateChanged(auth, (user) => {
    checkAuthorization(user);
    cargarIdeas();
  });

  // ============ SUPABASE FILE UPLOAD ============
  window.handleFileSelect = async function(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;

    const btnPublish = document.getElementById('btn-publish');
    btnPublish.disabled = true;
    btnPublish.textContent = 'Subiendo...';

    selectedFiles = [];
    const preview = document.getElementById('file-preview');

    for (const file of files) {
      try {
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
        const filePath = `${currentUser.uid}/${fileName}`;

        const { data, error } = await supabase
          .storage
          .from(SUPABASE_BUCKET)
          .upload(filePath, file, {
            cacheControl: '3600',
            upsert: false
          });

        if (error) throw error;

        const { data: { publicUrl } } = supabase
          .storage
          .from(SUPABASE_BUCKET)
          .getPublicUrl(filePath);

        selectedFiles.push({
          name: file.name,
          url: publicUrl,
          path: filePath
        });

      } catch (error) {
        console.error("Error uploading file:", error);
        alert(`Error subiendo ${file.name}: ${error.message}`);
      }
    }

    updateFilePreview();
    btnPublish.disabled = false;
    btnPublish.textContent = editingId ? 'Actualizar' : 'Publicar';
  };

  function updateFilePreview() {
    const preview = document.getElementById('file-preview');
    if (selectedFiles.length === 0) {
      preview.innerHTML = '';
      return;
    }
    preview.innerHTML = selectedFiles.map((file, index) => `
      <div class="file-preview-item">
        <span>üìÑ ${file.name}</span>
        <span class="remove-file" onclick="removeFile(${index})">√ó</span>
      </div>
    `).join('');
  }

  window.removeFile = function(index) {
    selectedFiles.splice(index, 1);
    updateFilePreview();
  };

  // ============ FIRESTORE ============
  window.cargarIdeas = async function() {
    try {
      const q = query(collection(db, "ideas"));
      const snapshot = await getDocs(q);
      posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
        .sort((a, b) => (b.timestamp?.toMillis?.() || 0) - (a.timestamp?.toMillis?.() || 0));
      render();
    } catch (e) { console.error("Error cargando:", e); }
  };

  window.guardarIdea = async function(ideaData) {
    if (!isAuthorized) { alert('üîê Sin permisos.'); return false; }
    try {
      const btn = document.getElementById('btn-publish');
      btn.textContent = 'Guardando...'; btn.disabled = true;
      
      if (editingId) {
        const ideaRef = doc(db, "ideas", editingId);
        await updateDoc(ideaRef, ideaData);
      } else {
        await addDoc(collection(db, "ideas"), ideaData);
      }
      
      btn.textContent = editingId ? 'Actualizar' : 'Publicar';
      btn.disabled = false;
      await cargarIdeas();
      return true;
    } catch (e) {
      console.error("Error guardando:", e);
      alert(e.code === 'permission-denied' ? 'üîê Permiso denegado.' : 'Error: ' + e.message);
      document.getElementById('btn-publish').textContent = editingId ? 'Actualizar' : 'Publicar';
      document.getElementById('btn-publish').disabled = false;
      return false;
    }
  };

  // ============ UI ============
  function render() {
    SECS.forEach(sec => {
      const grid = document.getElementById('grid-' + sec);
      const sp = posts.filter(p => p.section === sec);
      grid.innerHTML = sp.length
        ? sp.map(p => `<div class="card" onclick="openPost('${p.id}')">
            <div class="card-date">${p.date}</div>
            <div class="card-idea">${p.idea}</div>
            <div class="card-tags">${p.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>
            <div class="card-actions">
              ${isAuthorized ? `<button class="btn-edit" onclick="event.stopPropagation(); editIdea('${p.id}')">‚úèÔ∏è Editar</button>` : ''}
            </div>
            <div class="card-more">Leer m√°s ‚Üí</div>
          </div>`).join('')
        : `<div class="empty">Sin entradas a√∫n.</div>`;
    });
  }

  window.editIdea = async function(id) {
    if (!isAuthorized) { alert('üîê Inicia sesi√≥n para editar.'); return; }
    const post = posts.find(p => p.id === id);
    if (!post) return;
    
    editingId = id;
    selectedFiles = post.files || [];
    
    document.getElementById('form-title').textContent = 'Editar idea';
    document.getElementById('f-sec').value = post.section;
    document.getElementById('f-idea').value = post.idea;
    document.getElementById('f-body').value = post.body.replace(/<p>|<\/p>/g, '');
    document.getElementById('f-tags').value = post.tags.join(', ');
    
    updateFilePreview();
    document.getElementById('btn-publish').textContent = 'Actualizar';
    open_('form-overlay');
  };

  window.openPost = function(id) {
    const p = posts.find(x => x.id === id);
    if (!p) return;
    document.getElementById('m-cat').textContent = LABELS[p.section] || p.section;
    document.getElementById('m-title').textContent = p.idea;
    document.getElementById('m-body').innerHTML = p.body;
    document.getElementById('m-tags').innerHTML = p.tags.map(t=>`<span class="tag">${t}</span>`).join('');
    
    const filesDiv = document.getElementById('m-files');
    const filesContent = document.getElementById('m-files-content');
    if (p.files && p.files.length > 0) {
      filesDiv.style.display = 'block';
      filesContent.innerHTML = p.files.map(f => {
        const icon = getFileIcon(f.name || f.url);
        return `
          <div class="file-item">
            <a href="${f.url}" target="_blank" rel="noopener noreferrer">
              <span class="file-icon">${icon}</span>
              <span>${f.name || 'Descargar archivo'}</span>
            </a>
          </div>
        `;
      }).join('');
    } else {
      filesDiv.style.display = 'none';
    }
    
    open_('read-overlay');
  };

  function getFileIcon(filename) {
    if (!filename) return 'üìÑ';
    const lower = filename.toLowerCase();
    if (lower.includes('.pdf')) return 'üìï';
    if (lower.includes('.doc') || lower.includes('.txt')) return 'üìù';
    if (lower.includes('.xls') || lower.includes('.csv')) return 'üìä';
    if (lower.includes('.jpg') || lower.includes('.png') || lower.includes('.gif')) return 'üñºÔ∏è';
    if (lower.includes('.zip') || lower.includes('.rar')) return 'üì¶';
    return 'üìÑ';
  }

  window.openForm = function(sec) {
    if (!isAuthorized) { alert('üîê Inicia sesi√≥n con ' + AUTHORIZED_EMAIL); return; }
    editingId = null;
    selectedFiles = [];
    document.getElementById('form-title').textContent = 'Nueva idea';
    if (sec) document.getElementById('f-sec').value = sec;
    document.getElementById('f-idea').value = '';
    document.getElementById('f-body').value = '';
    document.getElementById('f-tags').value = '';
    document.getElementById('f-file-input').value = '';
    document.getElementById('file-preview').innerHTML = '';
    document.getElementById('btn-publish').textContent = 'Publicar';
    open_('form-overlay');
  };

  window.publish = async function() {
    if (!isAuthorized) { alert('üîê Sin permisos.'); return; }
    const idea = document.getElementById('f-idea').value.trim();
    const body = document.getElementById('f-body').value.trim();
    const section = document.getElementById('f-sec').value;
    const tagsRaw = document.getElementById('f-tags').value.trim();
    
    if (!idea || !body) { alert('Rellena idea y desarrollo.'); return; }
    
    const now = new Date();
    const date = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()} ¬∑ ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    const tags = tagsRaw ? tagsRaw.split(',').map(t=>t.trim()).filter(Boolean) : [];
    
    const ideaData = {
      section, date, idea,
      body: body.split('\n\n').map(p=>`<p>${p}</p>`).join(''),
      tags,
      files: selectedFiles,
      timestamp: Timestamp.now(),
      author: currentUser.email
    };
    
    const success = await guardarIdea(ideaData);
    if (success) {
      close_('form-overlay');
      editingId = null;
      selectedFiles = [];
      document.getElementById('f-file-input').value = '';
      document.getElementById('file-preview').innerHTML = '';
    }
  };

  window.open_ = id => document.getElementById(id).classList.add('open');
  window.close_ = id => document.getElementById(id).classList.remove('open');
  window.closeIfOutside = (e, id) => { if (e.target.id === id) close_(id); };

  window.filter = function(e, sec) {
    e.preventDefault();
    document.querySelectorAll('nav a').forEach(a => a.classList.toggle('active', a.dataset.sec === sec));
    document.querySelectorAll('.section').forEach(s => s.style.display = (sec === 'all' || s.id === sec) ? '' : 'none');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  cargarIdeas();
</script>

<script>
  window.open_ = id => document.getElementById(id).classList.add('open');
  window.close_ = id => document.getElementById(id).classList.remove('open');
  window.closeIfOutside = (e, id) => { if (e.target.id === id) close_(id); };
</script>

</body>
</html>
