<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mis Ideas</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f2ee; --bg2: #ede9e3; --black: #1a1a18; --dark: #2e2e2c;
      --red: #8b1c1c; --mid: #6b6b68; --border: #ccc8c0;
    }
    body {
      background: var(--bg); color: var(--black); font-family: 'Lato', sans-serif;
      font-weight: 300; min-height: 100vh;
    }
    body::before { content:''; display:block; height:3px; background:var(--red); position:fixed; top:0;left:0;right:0; z-index:999; }
    
    header {
      background:var(--black); padding:38px 40px 34px; display:flex; align-items:center;
      justify-content:space-between; flex-wrap:wrap; gap:16px; margin-top:3px; position:relative;
    }
    header::after { content:''; position:absolute; bottom:0;left:40px;right:40px; height:1px; background:rgba(255,255,255,0.07); }
    
    .site-title { font-family:'Playfair Display',serif; font-size:2rem; font-weight:900; color:#f0ede8; letter-spacing:0.02em; }
    .site-tagline { font-size:0.68rem; font-weight:700; letter-spacing:0.18em; text-transform:uppercase; color:rgba(240,237,232,0.35); margin-top:4px; }
    
    .auth-buttons { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn-login {
      background:#4285f4; color:white; border:none; border-radius:4px;
      font-family:'Lato',sans-serif; font-size:0.78rem; font-weight:700;
      padding:11px 22px; cursor:pointer; display:flex; align-items:center; gap:8px;
      transition:background 0.2s;
    }
    .btn-login:hover { background:#3367d6; }
    .btn-login img { width:18px; height:18px; }
    
    .btn-logout {
      background:transparent; color:rgba(240,237,232,0.7); border:1px solid rgba(255,255,255,0.3);
      font-family:'Lato',sans-serif; font-size:0.7rem; font-weight:700;
      padding:8px 16px; cursor:pointer; border-radius:4px; transition:all 0.2s;
    }
    .btn-logout:hover { background:rgba(255,255,255,0.1); color:#f0ede8; }
    
    .user-display { display: flex; align-items: center; gap: 10px; }
    
    .user-avatar {
      width: 36px; height: 36px; border-radius: 50%; object-fit: cover;
      border: 3px solid rgba(255,255,255,0.3); transition: border-color 0.2s; cursor: pointer;
    }
    .user-avatar:hover { border-color: rgba(255,255,255,0.7); }
    .user-avatar.color-rojo   { border-color: #8b1c1c !important; box-shadow: 0 0 0 1px #8b1c1c44; }
    .user-avatar.color-azul   { border-color: #1a4b8b !important; box-shadow: 0 0 0 1px #1a4b8b44; }
    .user-avatar.color-amarillo { border-color: #b8860b !important; box-shadow: 0 0 0 1px #b8860b44; }
    .user-avatar.color-verde  { border-color: #2e7d32 !important; box-shadow: 0 0 0 1px #2e7d3244; }
    
    .user-status {
      display: flex; align-items: center; gap: 6px; padding: 4px 10px;
      background: rgba(255,255,255,0.08); border-radius: 16px; font-size: 0.7rem;
      color: rgba(240,237,232,0.8);
    }
    .user-status::before {
      content: ''; display: inline-block; width: 6px; height: 6px;
      background: #4CAF50; border-radius: 50%; box-shadow: 0 0 6px rgba(76,175,80,0.5);
    }
    
    .btn-new {
      background:var(--red); color:#f0ede8; border:none;
      font-family:'Lato',sans-serif; font-size:0.78rem; font-weight:700;
      letter-spacing:0.12em; text-transform:uppercase; padding:11px 22px;
      cursor:pointer; transition:background 0.2s, transform 0.15s;
    }
    .btn-new:hover { background:#a52222; transform:translateY(-1px); }
    .btn-new:active { transform:translateY(0); }
    .btn-new:disabled { background:var(--mid); cursor:not-allowed; transform:none; opacity:0.7; }
    
    nav {
      background:var(--bg2); border-bottom:1px solid var(--border); display:flex;
      flex-wrap:wrap; padding:0 40px; position:sticky; top:3px; z-index:50;
      box-shadow:0 2px 12px rgba(0,0,0,0.06);
    }
    nav a {
      font-size:0.72rem; font-weight:700; letter-spacing:0.15em; text-transform:uppercase;
      color:var(--mid); text-decoration:none; padding:15px 18px; border-bottom:2px solid transparent;
      transition:all 0.2s; position:relative;
    }
    nav a:hover { color:var(--black); }
    nav a.active { color:var(--black); border-bottom-color:var(--red); }
    nav a.admin-only { display:none; }
    nav a.admin-only.visible { display:block; color: var(--red); }
    nav a.admin-only.visible:hover { color: var(--black); }
    nav a.admin-only.visible.active { color: var(--black); }
    
    main { max-width:960px; margin:0 auto; padding:54px 24px 90px; }
    .section { margin-bottom:66px; }
    .section-head {
      display:flex; align-items:baseline; justify-content:space-between;
      margin-bottom:26px; padding-bottom:12px; border-bottom:2px solid var(--black); position:relative;
    }
    .section-head::before { content:''; position:absolute; bottom:-2px; left:0; width:28px; height:2px; background:var(--red); }
    .section-head h2 { font-family:'Playfair Display',serif; font-size:1.25rem; font-weight:900; letter-spacing:0.02em; color:var(--black); }
    
    .btn-section-add {
      background:none; border:1px solid var(--border); color:var(--mid);
      font-family:'Lato',sans-serif; font-size:0.68rem; font-weight:700;
      letter-spacing:0.12em; text-transform:uppercase; padding:5px 13px;
      cursor:pointer; transition:all 0.2s; display:none;
    }
    .btn-section-add:hover { border-color:var(--black); color:var(--black); }
    .btn-section-add.show { display:inline-block; }

    .posts-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:14px; }
    
    .card {
      background:white; border:1px solid var(--border); border-top:3px solid var(--black);
      border-left:3px solid transparent; padding:22px 22px 18px; cursor:pointer;
      transition:border-top-color 0.2s, border-left-color 0.2s, box-shadow 0.2s, transform 0.2s; position:relative;
      text-decoration: none; display: block;
    }
    .card:hover {
      border-top-color:var(--black); border-left-color:var(--red);
      box-shadow:4px 6px 24px rgba(0,0,0,0.09); transform:translateY(-2px) translateX(1px);
    }
    .card-date { font-size:0.65rem; font-weight:700; letter-spacing:0.14em; text-transform:uppercase; color:var(--mid); margin-bottom:6px; }
    .card-author-top {
      font-size:0.62rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase;
      color:var(--red); margin-bottom:11px; display:flex; align-items:center; gap:6px;
    }
    .card-author-top img { width:16px; height:16px; border-radius:50%; object-fit:cover; }
    .card-idea { font-family:'Playfair Display',serif; font-size:1rem; font-weight:700; line-height:1.5; color:var(--black); margin-bottom:16px; }
    .card-tags { display:flex; flex-wrap:wrap; gap:5px; margin-bottom:14px; }
    .tag {
      font-size:0.6rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase;
      padding:3px 8px; background:var(--bg2); color:var(--mid); border:1px solid var(--border);
    }
    .card-footer {
      display:flex; justify-content:space-between; align-items:center; margin-top:12px;
      border-top:1px solid var(--bg2); padding-top:10px;
    }
    .card-author-bottom {
      font-size:0.6rem; color:var(--mid); display:flex; align-items:center; gap:5px;
    }
    .card-author-bottom img { width:14px; height:14px; border-radius:50%; object-fit:cover; }
    .card-more { font-size:0.7rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:var(--red); opacity:0; transition:opacity 0.2s; }
    .card:hover .card-more { opacity:1; }
    
    .card-actions { display:flex; gap:8px; margin-top:8px; }
    .btn-edit {
      background:var(--bg2); border:1px solid var(--border); color:var(--black);
      font-family:'Lato',sans-serif; font-size:0.65rem; font-weight:700;
      letter-spacing:0.1em; text-transform:uppercase; padding:6px 12px;
      cursor:pointer; transition:all 0.2s; border-radius:3px;
    }
    .btn-edit:hover { background:var(--border); }
    .empty { font-size:0.82rem; color:var(--mid); font-style:italic; padding:18px 20px; border:1px dashed var(--border); background:white; }
    
    /* ---- PANEL USUARIOS (admin only) ---- */
    #section-usuarios { display:none; }
    #section-usuarios.visible { display:block; }
    
    .user-table { width:100%; border-collapse:collapse; background:white; border:1px solid var(--border); }
    .user-table th {
      font-size:0.65rem; font-weight:700; letter-spacing:0.14em; text-transform:uppercase;
      color:var(--mid); padding:12px 16px; text-align:left; border-bottom:2px solid var(--black);
      background:var(--bg2);
    }
    .user-table td { padding:12px 16px; border-bottom:1px solid var(--bg2); font-size:0.85rem; vertical-align:middle; }
    .user-table tr:last-child td { border-bottom:none; }
    .user-table tr:hover td { background:var(--bg); }
    
    .user-row-info { display:flex; align-items:center; gap:10px; }
    .user-row-info img { width:28px; height:28px; border-radius:50%; object-fit:cover; }
    .user-row-name { font-weight:700; color:var(--black); }
    .user-row-email { font-size:0.75rem; color:var(--mid); }
    
    .permission-badge {
      display:inline-block; padding:3px 10px; border-radius:20px; font-size:0.65rem;
      font-weight:700; letter-spacing:0.1em; text-transform:uppercase;
    }
    .permission-badge.yes    { background:#e8f5e9; color:#2e7d32; }
    .permission-badge.comment{ background:#e3f2fd; color:#1565c0; }
    .permission-badge.no     { background:#fce4ec; color:#c62828; }
    .permission-badge.admin  { background:#1a1a18; color:#f0ede8; }

    /* Online dot */
    .online-dot {
      display:inline-block; width:8px; height:8px; border-radius:50%;
      flex-shrink:0; margin-right:2px;
    }
    .online-dot.online  { background:#4CAF50; box-shadow:0 0 5px rgba(76,175,80,0.7); }
    .online-dot.offline { background:#bbb; }

    /* User color dot en tabla */
    .user-color-dot {
      width:10px; height:10px; border-radius:50%; display:inline-block;
      flex-shrink:0; border:1px solid rgba(0,0,0,0.1);
    }

    /* Botones de permiso m√∫ltiple */
    .perm-btns { display:flex; gap:6px; flex-wrap:wrap; }
    .btn-perm {
      border:none; font-family:'Lato',sans-serif; font-size:0.62rem; font-weight:700;
      letter-spacing:0.08em; text-transform:uppercase; padding:5px 10px;
      cursor:pointer; transition:all 0.2s; border-radius:3px; white-space:nowrap;
    }
    .btn-perm.grant-comment { background:#e3f2fd; color:#1565c0; }
    .btn-perm.grant-comment:hover { background:#1565c0; color:white; }
    .btn-perm.grant-write   { background:#e8f5e9; color:#2e7d32; }
    .btn-perm.grant-write:hover { background:#2e7d32; color:white; }
    .btn-perm.revoke-all    { background:#fce4ec; color:#c62828; }
    .btn-perm.revoke-all:hover { background:#c62828; color:white; }
    
    /* ---- MODALS ---- */
    .overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(20,20,18,0.75); z-index: 200;
      align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(2px);
    }
    .overlay.open { display: flex; }
    
    .form-box {
      background: white; max-width: 560px; width: 100%;
      border-top: 4px solid var(--black); position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25); animation: up 0.25s ease;
      max-height: 85vh; overflow-y: auto;
    }
    .form-head { padding: 26px 28px 18px; border-bottom: 1px solid var(--border); }
    .form-head h2 { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; color: var(--black); }
    .form-body { padding: 24px 28px; display: flex; flex-direction: column; gap: 18px; }
    .form-group { display: flex; flex-direction: column; gap: 7px; }
    .form-group label { font-size: 0.65rem; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--mid); }
    .form-group input, .form-group textarea, .form-group select {
      border: 1px solid var(--border); border-bottom-width: 2px;
      background: var(--bg); color: var(--black); font-family: 'Lato', sans-serif;
      font-size: 0.95rem; font-weight: 300; padding: 10px 12px; outline: none;
      transition: border-color 0.2s, background 0.2s; resize: vertical;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      border-color: var(--black); border-bottom-color: var(--red); background: white;
    }
    
    .btn-upload {
      background: var(--bg2); border: 2px dashed var(--border); padding: 12px 20px;
      text-align: center; cursor: pointer; border-radius: 4px; transition: all 0.2s;
      font-size: 0.9rem; color: var(--black);
    }
    .btn-upload:hover { border-color: var(--black); background: var(--bg); }
    .file-list-preview { margin-top: 10px; }
    .file-preview-item {
      display: flex; align-items: center; gap: 8px; padding: 6px 10px;
      background: var(--bg); border: 1px solid var(--border); border-radius: 4px;
      margin-bottom: 5px; font-size: 0.85rem;
    }
    .file-preview-item .remove-file { cursor: pointer; color: var(--red); font-weight: bold; padding: 0 5px; }
    .file-preview-item .remove-file:hover { color: var(--black); }
    
    .form-foot {
      padding: 14px 28px 24px; display: flex; justify-content: flex-end;
      gap: 10px; border-top: 1px solid var(--border);
    }
    .btn-cancel {
      background: none; border: 1px solid var(--border); color: var(--mid);
      font-family: 'Lato', sans-serif; font-size: 0.72rem; font-weight: 700;
      letter-spacing: 0.1em; text-transform: uppercase; padding: 9px 18px;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-cancel:hover { border-color: var(--mid); color: var(--black); }
    .btn-pub {
      background: var(--black); border: none; color: white;
      font-family: 'Lato', sans-serif; font-size: 0.72rem; font-weight: 700;
      letter-spacing: 0.1em; text-transform: uppercase; padding: 9px 24px;
      cursor: pointer; transition: background 0.2s;
    }
    .btn-pub:hover { background: var(--red); }
    .btn-pub:disabled { background: var(--mid); cursor: not-allowed; }
    .modal-close {
      position: absolute; top: 14px; right: 18px; background: none; border: none;
      font-size: 1rem; cursor: pointer; color: var(--mid); transition: color 0.15s;
      min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;
    }
    .modal-close:hover { color: var(--black); }
    
    /* ---- MODAL NOMBRE ---- */
    .name-modal-box {
      background: white; max-width: 460px; width: 100%;
      border-top: 4px solid var(--red); position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25); animation: up 0.25s ease;
      padding: 30px 32px;
    }
    .name-modal-box h2 {
      font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700;
      color: var(--black); margin-bottom: 6px;
    }
    .name-modal-box p { font-size: 0.82rem; color: var(--mid); margin-bottom: 20px; line-height:1.5; }
    .name-input-row { display:flex; gap:8px; margin-bottom:22px; }
    .name-input-row input {
      flex:1; border:1px solid var(--border); border-bottom-width:2px; background:var(--bg);
      color:var(--black); font-family:'Lato',sans-serif; font-size:0.95rem; padding:10px 12px;
      outline:none; transition:border-color 0.2s;
    }
    .name-input-row input:focus { border-color:var(--black); border-bottom-color:var(--red); background:white; }
    .btn-save-name {
      background:var(--black); color:white; border:none; font-family:'Lato',sans-serif;
      font-size:0.72rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase;
      padding:10px 18px; cursor:pointer; transition:background 0.2s; white-space:nowrap;
    }
    .btn-save-name:hover { background:var(--red); }

    /* Color picker */
    .color-picker-label {
      font-size:0.65rem; font-weight:700; letter-spacing:0.14em; text-transform:uppercase;
      color:var(--mid); margin-bottom:10px; display:block;
    }
    .color-options { display:flex; gap:12px; }
    .color-opt {
      width:36px; height:36px; border-radius:50%; cursor:pointer;
      border:3px solid transparent; transition:all 0.2s; position:relative;
      display:flex; align-items:center; justify-content:center;
    }
    .color-opt:hover { transform:scale(1.1); }
    .color-opt.selected { border-color: var(--black) !important; }
    .color-opt.selected::after {
      content:'‚úì'; color:white; font-size:0.85rem; font-weight:900;
      text-shadow:0 1px 2px rgba(0,0,0,0.5);
    }
    .color-opt[data-color="ninguno"]  { background: #ccc8c0; border-color:#ccc8c0; }
    .color-opt[data-color="rojo"]     { background: #8b1c1c; }
    .color-opt[data-color="azul"]     { background: #1a4b8b; }
    .color-opt[data-color="amarillo"] { background: #b8860b; }
    .color-opt[data-color="verde"]    { background: #2e7d32; }
    
    @keyframes up { from { opacity:0; transform:translateY(14px); } to { opacity:1; transform:translateY(0); } }
    ::-webkit-scrollbar { width:4px; }
    ::-webkit-scrollbar-track { background:var(--bg2); }
    ::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
    
    @media(max-width:580px){
      header{ padding:20px 16px 16px; flex-direction:column; align-items:flex-start; gap:12px; }
      .site-title{ font-size:1.5rem; }
      .auth-buttons{ width:100%; justify-content:flex-end; }
      .btn-login{ padding:10px 16px; font-size:0.75rem; min-height:44px; }
      .btn-logout{ padding:8px 14px; font-size:0.65rem; min-height:44px; }
      .user-avatar{ width:32px; height:32px; }
      .btn-new{ padding:10px 18px; font-size:0.7rem; min-height:44px; }
      nav{ padding:0; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
      nav::-webkit-scrollbar{ display:none; }
      nav a{ padding:14px 12px; font-size:0.65rem; white-space:nowrap; min-height:44px; display:flex; align-items:center; }
      main{ padding:24px 12px 40px; }
      .section{ margin-bottom:40px; }
      .section-head{ flex-direction:column; gap:10px; margin-bottom:20px; }
      .section-head h2{ font-size:1.1rem; }
      .btn-section-add{ padding:8px 16px; font-size:0.65rem; min-height:44px; width:100%; text-align:center; }
      .posts-grid{ grid-template-columns:1fr; gap:12px; }
      .card{ padding:18px 16px 16px; }
      .overlay{ padding:0; }
      .form-box{ width:100%; max-width:100%; height:100%; max-height:100vh; border-radius:0; }
      .form-body{ padding:16px; overflow-y:auto; }
      .form-group input, .form-group textarea, .form-group select{ padding:12px; font-size:16px; min-height:44px; }
      .form-foot{ padding:12px 16px 20px; flex-direction:column-reverse; gap:8px; }
      .btn-cancel, .btn-pub{ width:100%; padding:12px 20px; min-height:48px; font-size:0.75rem; }
      .user-table { font-size:0.75rem; }
      .user-table th, .user-table td { padding:8px 10px; }
    }
  </style>
</head>
<body>

<header>
  <div>
    <div class="site-title">Mis Ideas</div>
    <div class="site-tagline">Cuaderno de pensamiento</div>
  </div>
  <div class="auth-buttons">
    <div id="user-display" class="user-display" style="display:none;">
      <img id="user-avatar" class="user-avatar" src="" alt="Perfil" onclick="openNameModal()" title="Cambiar nombre">
      <span class="user-status" id="user-display-name">Conectado</span>
      <button class="btn-logout" onclick="logout()">Salir</button>
    </div>
    <button id="btn-login" class="btn-login" onclick="loginWithGoogle()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
      Acceder
    </button>
    <button id="btn-new-idea" class="btn-new" onclick="openForm()" style="display:none;">+ Nueva idea</button>
  </div>
</header>

<nav id="nav">
  <a href="#" onclick="filter(event,'all')" class="active" data-sec="all">Todo</a>
  <a href="#" onclick="filter(event,'politica')" data-sec="politica">Pol√≠tica</a>
  <a href="#" onclick="filter(event,'sociedad')" data-sec="sociedad">Sociedad</a>
  <a href="#" onclick="filter(event,'economia')" data-sec="economia">Econom√≠a</a>
  <a href="#" onclick="filter(event,'cultura')" data-sec="cultura">Cultura</a>
  <a href="#" onclick="filter(event,'historia')" data-sec="historia">Historia</a>
  <a href="#" onclick="filter(event,'usuarios')" data-sec="usuarios" class="admin-only" id="nav-usuarios">üë• Usuarios</a>
</nav>

<main>
  <!-- Secciones de ideas -->
  <div class="section" id="politica">
    <div class="section-head">
      <h2>Pol√≠tica</h2>
      <button class="btn-section-add" onclick="openForm('politica')" id="btn-add-politica">+ A√±adir</button>
    </div>
    <div class="posts-grid" id="grid-politica"></div>
  </div>
  <div class="section" id="sociedad">
    <div class="section-head">
      <h2>Sociedad</h2>
      <button class="btn-section-add" onclick="openForm('sociedad')" id="btn-add-sociedad">+ A√±adir</button>
    </div>
    <div class="posts-grid" id="grid-sociedad"></div>
  </div>
  <div class="section" id="economia">
    <div class="section-head">
      <h2>Econom√≠a</h2>
      <button class="btn-section-add" onclick="openForm('economia')" id="btn-add-economia">+ A√±adir</button>
    </div>
    <div class="posts-grid" id="grid-economia"></div>
  </div>
  <div class="section" id="cultura">
    <div class="section-head">
      <h2>Cultura</h2>
      <button class="btn-section-add" onclick="openForm('cultura')" id="btn-add-cultura">+ A√±adir</button>
    </div>
    <div class="posts-grid" id="grid-cultura"></div>
  </div>
  <div class="section" id="historia">
    <div class="section-head">
      <h2>Historia</h2>
      <button class="btn-section-add" onclick="openForm('historia')" id="btn-add-historia">+ A√±adir</button>
    </div>
    <div class="posts-grid" id="grid-historia"></div>
  </div>

  <!-- Panel Usuarios (solo admin) -->
  <div class="section" id="section-usuarios">
    <div class="section-head">
      <h2>üë• Usuarios registrados</h2>
    </div>
    <div id="usuarios-content">
      <p style="color:var(--mid); font-style:italic;">Cargando usuarios...</p>
    </div>
  </div>
</main>

<!-- Modal nueva/editar idea -->
<div class="overlay" id="form-overlay" onclick="closeIfOutside(event,'form-overlay')">
  <div class="form-box">
    <button class="modal-close" onclick="close_('form-overlay')">‚úï</button>
    <div class="form-head"><h2 id="form-title">Nueva idea</h2></div>
    <div class="form-body">
      <div class="form-group">
        <label>Secci√≥n</label>
        <select id="f-sec">
          <option value="politica">Pol√≠tica</option>
          <option value="sociedad">Sociedad</option>
          <option value="economia">Econom√≠a</option>
          <option value="cultura">Cultura</option>
          <option value="historia">Historia</option>
        </select>
      </div>
      <div class="form-group">
        <label>Idea en una frase</label>
        <input id="f-idea" type="text" placeholder="La idea principal...">
      </div>
      <div class="form-group">
        <label>Desarrollo</label>
        <textarea id="f-body" rows="6" placeholder="Escribe tu argumento completo. Separa p√°rrafos con una l√≠nea en blanco."></textarea>
      </div>
      <div class="form-group">
        <label>Etiquetas (separadas por coma)</label>
        <input id="f-tags" type="text" placeholder="naci√≥n, orden, pol√≠tica">
      </div>
      <div class="form-group">
        <label>Archivos adjuntos</label>
        <input type="file" id="f-file-input" multiple style="display:none" onchange="handleFileSelect(event)">
        <div class="btn-upload" onclick="document.getElementById('f-file-input').click()">
          üìé Click para seleccionar archivos
        </div>
        <div class="file-list-preview" id="file-preview"></div>
      </div>
    </div>
    <div class="form-foot">
      <button class="btn-cancel" onclick="close_('form-overlay')">Cancelar</button>
      <button class="btn-pub" onclick="publish()" id="btn-publish">Publicar</button>
    </div>
  </div>
</div>

<!-- Modal cambiar nombre -->
<div class="overlay" id="name-overlay" onclick="closeIfOutside(event,'name-overlay')">
  <div class="name-modal-box">
    <button class="modal-close" onclick="close_('name-overlay')">‚úï</button>
    <h2>Tu perfil p√∫blico</h2>
    <p>Tu nombre y color aparecer√°n como autor. Haz clic en tu foto del header para editar.</p>
    <div class="name-input-row">
      <input id="custom-name-input" type="text" placeholder="Tu nombre...">
      <button class="btn-save-name" onclick="saveName()">Guardar</button>
    </div>
    <span class="color-picker-label">Color de tu borde</span>
    <div class="color-options">
      <div class="color-opt" data-color="ninguno" onclick="selectColor('ninguno')" title="Sin color"></div>
      <div class="color-opt" data-color="rojo"     onclick="selectColor('rojo')"     title="Rojo"></div>
      <div class="color-opt" data-color="azul"     onclick="selectColor('azul')"     title="Azul"></div>
      <div class="color-opt" data-color="amarillo" onclick="selectColor('amarillo')" title="Amarillo"></div>
      <div class="color-opt" data-color="verde"    onclick="selectColor('verde')"    title="Verde"></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, Timestamp, doc, updateDoc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const firebaseConfig = {
    apiKey: "AIzaSyD57cIHb-k4bhMwKvoDHp2uOcJw_EDPVxg",
    authDomain: "netnull-a9a18.firebaseapp.com",
    projectId: "netnull-a9a18",
    storageBucket: "netnull-a9a18.firebasestorage.app",
    messagingSenderId: "85420219235",
    appId: "1:85420219235:web:b7a93121caa8519602d156"
  };

  const supabaseUrl = 'https://epuppytaijalxggsmnhn.supabase.co';
  const supabaseAnonKey = 'sb_publishable_nHDee2p3jhqi1iKsANLXJQ_FHZTqIiv';
  const supabase = createClient(supabaseUrl, supabaseAnonKey);
  const SUPABASE_BUCKET = 'archivos';

  const ADMIN_EMAIL = 'nilelpeque@gmail.com';

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  let posts = [];
  let currentUser = null;
  let isAdmin = false;
  let canWrite = false;
  let canComment = false;
  let myDisplayName = '';
  let myProfileColor = 'ninguno';
  let editingId = null;
  let selectedFiles = [];

  const LABELS = { politica:'Pol√≠tica', sociedad:'Sociedad', economia:'Econom√≠a', cultura:'Cultura', historia:'Historia' };
  const SECS = Object.keys(LABELS);

  // ‚Äî‚Äî‚Äî AUTH ‚Äî‚Äî‚Äî
  window.loginWithGoogle = async function() {
    try {
      await signInWithPopup(auth, provider);
    } catch (err) {
      alert("Error: " + err.message);
    }
  };

  window.logout = async function() {
    await signOut(auth);
  };

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (user) {
      isAdmin = user.email === ADMIN_EMAIL;
      if (isAdmin) { canWrite = true; canComment = true; }
      myDisplayName = user.displayName || user.email.split('@')[0];
      updateUI();
      try {
        await registerUser(user);
        const userData = await getUserData(user.uid);
        if (userData?.displayName) myDisplayName = userData.displayName;
        myProfileColor = userData?.profileColor || 'ninguno';
        canWrite = isAdmin || userData?.canWrite === true;
        canComment = canWrite || userData?.canComment === true;
        // Actualizar lastSeen
        await updateDoc(doc(db, 'usuarios', user.uid), { lastSeen: Timestamp.now() });
        // Seguir actualizando cada 60s mientras est√° en la p√°gina
        setInterval(async () => {
          if (auth.currentUser) {
            try { await updateDoc(doc(db, 'usuarios', auth.currentUser.uid), { lastSeen: Timestamp.now() }); } catch {}
          }
        }, 60000);
        updateUI();
      } catch (e) {
        console.warn('Error al cargar datos de usuario:', e.message);
      }
    } else {
      isAdmin = false; canWrite = false; canComment = false;
      myDisplayName = ''; myProfileColor = 'ninguno';
      updateUI();
    }
    cargarIdeas();
    if (isAdmin) loadUsuarios();
  });

  async function registerUser(user) {
    const ref = doc(db, 'usuarios', user.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, {
        email: user.email,
        displayName: user.displayName || user.email.split('@')[0],
        photoURL: user.photoURL || '',
        canWrite: false,
        canComment: false,
        profileColor: 'ninguno',
        lastSeen: Timestamp.now(),
        firstSeen: Timestamp.now()
      });
    } else {
      await updateDoc(ref, {
        email: user.email,
        photoURL: user.photoURL || snap.data().photoURL || ''
      });
    }
  }

  async function getUserData(uid) {
    try {
      const snap = await getDoc(doc(db, 'usuarios', uid));
      return snap.exists() ? snap.data() : null;
    } catch { return null; }
  }

  function updateUI() {
    const btnLogin = document.getElementById('btn-login');
    const btnNewIdea = document.getElementById('btn-new-idea');
    const userDisplay = document.getElementById('user-display');
    const userAvatar = document.getElementById('user-avatar');
    const userDisplayName = document.getElementById('user-display-name');
    const navUsuarios = document.getElementById('nav-usuarios');
    const addBtns = document.querySelectorAll('.btn-section-add');

    if (currentUser) {
      btnLogin.style.display = 'none';
      userDisplay.style.display = 'flex';
      userAvatar.src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(myDisplayName)}&background=1a1a18&color=f0ede8`;
      userDisplayName.textContent = myDisplayName;
      // Aplicar color de borde al avatar del header
      userAvatar.className = 'user-avatar' + (myProfileColor && myProfileColor !== 'ninguno' ? ` color-${myProfileColor}` : '');
    } else {
      btnLogin.style.display = 'inline-block';
      userDisplay.style.display = 'none';
    }

    if (canWrite) {
      btnNewIdea.style.display = 'inline-block';
      addBtns.forEach(b => b.classList.add('show'));
    } else {
      btnNewIdea.style.display = 'none';
      addBtns.forEach(b => b.classList.remove('show'));
    }

    if (isAdmin) {
      navUsuarios.classList.add('visible');
    } else {
      navUsuarios.classList.remove('visible');
      document.getElementById('section-usuarios').classList.remove('visible');
    }
  }

  // ‚Äî‚Äî‚Äî NOMBRE Y COLOR ‚Äî‚Äî‚Äî
  let selectedColor = 'ninguno';

  window.openNameModal = function() {
    if (!currentUser) return;
    document.getElementById('custom-name-input').value = myDisplayName;
    selectedColor = myProfileColor || 'ninguno';
    // Marcar color seleccionado
    document.querySelectorAll('.color-opt').forEach(el => {
      el.classList.toggle('selected', el.dataset.color === selectedColor);
    });
    open_('name-overlay');
  };

  window.selectColor = function(color) {
    selectedColor = color;
    document.querySelectorAll('.color-opt').forEach(el => {
      el.classList.toggle('selected', el.dataset.color === color);
    });
  };

  window.saveName = async function() {
    const name = document.getElementById('custom-name-input').value.trim();
    if (!name) { alert('Escribe un nombre.'); return; }
    try {
      await updateDoc(doc(db, 'usuarios', currentUser.uid), { displayName: name, profileColor: selectedColor });
      myDisplayName = name;
      myProfileColor = selectedColor;
      document.getElementById('user-display-name').textContent = name;

      // Actualizar nombre en todas las ideas de este usuario
      const snap = await getDocs(collection(db, 'ideas'));
      const misIdeas = snap.docs.filter(d => d.data().author === currentUser.email);
      await Promise.all(misIdeas.map(d => updateDoc(doc(db, 'ideas', d.id), { authorName: name, authorColor: selectedColor })));

      updateUI(); // Actualizar borde del avatar
      close_('name-overlay');
      await cargarIdeas();
    } catch (err) {
      alert('Error al guardar: ' + err.message);
    }
  };

  // ‚Äî‚Äî‚Äî CARGAR USUARIOS (admin) ‚Äî‚Äî‚Äî
  async function loadUsuarios() {
    try {
      const snap = await getDocs(collection(db, 'usuarios'));
      const usuarios = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
      renderUsuarios(usuarios);
    } catch (err) {
      document.getElementById('usuarios-content').innerHTML = `<p style="color:var(--red)">Error: ${err.message}</p>`;
    }
  }

  function renderUsuarios(usuarios) {
    const container = document.getElementById('usuarios-content');
    if (usuarios.length === 0) {
      container.innerHTML = '<p style="color:var(--mid);font-style:italic">No hay usuarios registrados a√∫n.</p>';
      return;
    }
    const now = Date.now();
    const ONLINE_THRESHOLD = 2 * 60 * 1000; // 2 minutos

    const COLORS = { rojo:'#8b1c1c', azul:'#1a4b8b', amarillo:'#b8860b', verde:'#2e7d32', ninguno:'#ccc8c0' };

    container.innerHTML = `
      <table class="user-table">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Estado</th>
            <th>Permiso</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          ${usuarios.map(u => {
            const isAdminUser = u.email === ADMIN_EMAIL;
            const color = COLORS[u.profileColor] || COLORS.ninguno;
            const avatar = u.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.displayName||'?')}&background=1a1a18&color=f0ede8`;
            const lastSeenMs = u.lastSeen?.toMillis?.() || 0;
            const isOnline = lastSeenMs && (now - lastSeenMs) < ONLINE_THRESHOLD;
            const onlineText = isOnline ? 'Conectado' : (lastSeenMs ? 'Desconectado' : 'Nunca');

            let badge = '';
            if (isAdminUser) badge = '<span class="permission-badge admin">Admin</span>';
            else if (u.canWrite) badge = '<span class="permission-badge yes">Puede escribir</span>';
            else if (u.canComment) badge = '<span class="permission-badge comment">Solo comentar</span>';
            else badge = '<span class="permission-badge no">Solo lectura</span>';

            let actions = '‚Äî';
            if (!isAdminUser) {
              actions = `<div class="perm-btns">
                ${!u.canComment && !u.canWrite ? `<button class="btn-perm grant-comment" onclick="setPermiso('${u.uid}','comment')">üí¨ Comentar</button>` : ''}
                ${!u.canWrite ? `<button class="btn-perm grant-write" onclick="setPermiso('${u.uid}','write')">‚úçÔ∏è Escribir</button>` : ''}
                ${(u.canComment || u.canWrite) ? `<button class="btn-perm revoke-all" onclick="setPermiso('${u.uid}','none')">‚õî Quitar</button>` : ''}
              </div>`;
            }

            return `
              <tr>
                <td>
                  <div class="user-row-info">
                    <div style="position:relative;flex-shrink:0;">
                      <img src="${avatar}" alt="" style="width:28px;height:28px;border-radius:50%;object-fit:cover;border:2px solid ${color};">
                      <span class="online-dot ${isOnline ? 'online' : 'offline'}" style="position:absolute;bottom:-1px;right:-1px;width:9px;height:9px;border:1.5px solid white;border-radius:50%;"></span>
                    </div>
                    <div>
                      <div class="user-row-name">${u.displayName || '‚Äî'}</div>
                      <div class="user-row-email">${u.email}</div>
                    </div>
                  </div>
                </td>
                <td style="font-size:0.75rem;color:${isOnline ? '#2e7d32' : 'var(--mid)'};">
                  ${onlineText}
                </td>
                <td>${badge}</td>
                <td>${actions}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    `;
  }

  window.setPermiso = async function(uid, level) {
    try {
      const updates = {
        canWrite:   level === 'write',
        canComment: level === 'write' || level === 'comment'
      };
      await updateDoc(doc(db, 'usuarios', uid), updates);
      await loadUsuarios();
    } catch (err) {
      alert('Error: ' + err.message);
    }
  };

  // ‚Äî‚Äî‚Äî IDEAS ‚Äî‚Äî‚Äî
  window.cargarIdeas = async function() {
    try {
      const snap = await getDocs(query(collection(db, "ideas")));
      posts = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => (b.timestamp?.toMillis?.() || 0) - (a.timestamp?.toMillis?.() || 0));
      render();
    } catch (e) { console.error("Error cargando:", e); }
  };

  function render() {
    SECS.forEach(sec => {
      const grid = document.getElementById('grid-' + sec);
      const sp = posts.filter(p => p.section === sec);
      grid.innerHTML = sp.length
        ? sp.map(p => {
            const authorName = p.authorName || p.author?.split('@')[0] || 'Autor';
            const authorPhoto = p.authorPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(authorName)}&background=1a1a18&color=f0ede8&size=32`;
            return `<a href="detalle.html?id=${p.id}" class="card">
              <div class="card-date">${p.date}</div>
              <div class="card-author-top">
                <img src="${authorPhoto}" alt="${authorName}" onerror="this.style.display='none'">
                ${authorName}
              </div>
              <div class="card-idea">${p.idea}</div>
              <div class="card-tags">${p.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>
              <div class="card-actions">
                ${(isAdmin || (canWrite && p.author === currentUser?.email)) ? `<button class="btn-edit" onclick="event.stopPropagation(); event.preventDefault(); editIdea('${p.id}')">‚úèÔ∏è Editar</button>` : ''}
              </div>
              <div class="card-footer">
                <div class="card-author-bottom">
                  <img src="${authorPhoto}" alt="" onerror="this.style.display='none'">
                  Por ${authorName}
                </div>
                <div class="card-more">Leer m√°s ‚Üí</div>
              </div>
            </a>`;
          }).join('')
        : `<div class="empty">Sin entradas a√∫n.</div>`;
    });
  }

  window.editIdea = async function(id) {
    if (!canWrite) { alert('üîê Sin permisos.'); return; }
    const post = posts.find(p => p.id === id);
    if (!post) return;
    editingId = id;
    selectedFiles = post.files || [];
    document.getElementById('form-title').textContent = 'Editar idea';
    document.getElementById('f-sec').value = post.section;
    document.getElementById('f-idea').value = post.idea;
    document.getElementById('f-body').value = post.body.replace(/<p>|<\/p>/g, '').replace(/<\/p><p>/g, '\n\n');
    document.getElementById('f-tags').value = post.tags.join(', ');
    updateFilePreview();
    document.getElementById('btn-publish').textContent = 'Actualizar';
    open_('form-overlay');
  };

  window.openForm = function(sec) {
    if (!canWrite) { alert('üîê No tienes permiso para escribir.'); return; }
    editingId = null;
    selectedFiles = [];
    document.getElementById('form-title').textContent = 'Nueva idea';
    if (sec) document.getElementById('f-sec').value = sec;
    document.getElementById('f-idea').value = '';
    document.getElementById('f-body').value = '';
    document.getElementById('f-tags').value = '';
    document.getElementById('f-file-input').value = '';
    document.getElementById('file-preview').innerHTML = '';
    document.getElementById('btn-publish').textContent = 'Publicar';
    open_('form-overlay');
  };

  window.publish = async function() {
    if (!canWrite) { alert('üîê Sin permisos.'); return; }
    const idea = document.getElementById('f-idea').value.trim();
    const body = document.getElementById('f-body').value.trim();
    const section = document.getElementById('f-sec').value;
    const tagsRaw = document.getElementById('f-tags').value.trim();
    if (!idea || !body) { alert('Rellena idea y desarrollo.'); return; }
    const now = new Date();
    const date = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()} ¬∑ ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    const tags = tagsRaw ? tagsRaw.split(',').map(t=>t.trim()).filter(Boolean) : [];
    const ideaData = {
      section, date, idea,
      body: body.split('\n\n').map(p=>`<p>${p}</p>`).join(''),
      tags,
      files: selectedFiles,
      timestamp: Timestamp.now(),
      author: currentUser.email,
      authorName: myDisplayName,
      authorPhoto: currentUser.photoURL || ''
    };
    try {
      const btn = document.getElementById('btn-publish');
      btn.textContent = 'Guardando...'; btn.disabled = true;
      if (editingId) {
        await updateDoc(doc(db, "ideas", editingId), ideaData);
      } else {
        await addDoc(collection(db, "ideas"), ideaData);
      }
      btn.textContent = editingId ? 'Actualizar' : 'Publicar';
      btn.disabled = false;
      close_('form-overlay');
      editingId = null;
      selectedFiles = [];
      document.getElementById('f-file-input').value = '';
      document.getElementById('file-preview').innerHTML = '';
      await cargarIdeas();
    } catch (e) {
      alert(e.code === 'permission-denied' ? 'üîê Permiso denegado en Firebase.' : 'Error: ' + e.message);
      document.getElementById('btn-publish').textContent = editingId ? 'Actualizar' : 'Publicar';
      document.getElementById('btn-publish').disabled = false;
    }
  };

  // ‚Äî‚Äî‚Äî ARCHIVOS ‚Äî‚Äî‚Äî
  window.handleFileSelect = async function(event) {
    const files = Array.from(event.target.files);
    if (!files.length) return;
    const btn = document.getElementById('btn-publish');
    btn.disabled = true; btn.textContent = 'Subiendo...';
    selectedFiles = [];
    for (const file of files) {
      try {
        const ext = file.name.split('.').pop();
        const path = `${currentUser.uid}/${Date.now()}_${Math.random().toString(36).substring(2)}.${ext}`;
        const { error } = await supabase.storage.from(SUPABASE_BUCKET).upload(path, file, { cacheControl:'3600', upsert:false });
        if (error) throw error;
        const { data: { publicUrl } } = supabase.storage.from(SUPABASE_BUCKET).getPublicUrl(path);
        selectedFiles.push({ name: file.name, url: publicUrl, path });
      } catch (err) {
        alert(`Error subiendo ${file.name}: ${err.message}`);
      }
    }
    updateFilePreview();
    btn.disabled = false; btn.textContent = editingId ? 'Actualizar' : 'Publicar';
  };

  function updateFilePreview() {
    const preview = document.getElementById('file-preview');
    preview.innerHTML = selectedFiles.map((f, i) => `
      <div class="file-preview-item">
        <span>üìÑ ${f.name}</span>
        <span class="remove-file" onclick="removeFile(${i})">√ó</span>
      </div>`).join('');
  }

  window.removeFile = function(i) { selectedFiles.splice(i, 1); updateFilePreview(); };

  // ‚Äî‚Äî‚Äî FILTRO NAV ‚Äî‚Äî‚Äî
  window.filter = function(e, sec) {
    e.preventDefault();
    document.querySelectorAll('nav a').forEach(a => a.classList.toggle('active', a.dataset.sec === sec));
    // Show/hide sections
    document.querySelectorAll('.section').forEach(s => {
      if (s.id === 'section-usuarios') return; // handle separately
      s.style.display = (sec === 'all' || s.id === sec) ? '' : 'none';
    });
    const usersPanel = document.getElementById('section-usuarios');
    if (sec === 'usuarios' && isAdmin) {
      usersPanel.classList.add('visible');
      loadUsuarios();
    } else {
      usersPanel.classList.remove('visible');
    }
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // ‚Äî‚Äî‚Äî HELPERS ‚Äî‚Äî‚Äî
  window.open_ = id => document.getElementById(id).classList.add('open');
  window.close_ = id => document.getElementById(id).classList.remove('open');
  window.closeIfOutside = (e, id) => { if (e.target.id === id) close_(id); };

  cargarIdeas();
</script>

</body>
</html>
