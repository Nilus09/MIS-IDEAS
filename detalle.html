<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mis Ideas - Detalle</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f2ee; --bg2: #ede9e3; --black: #1a1a18; --dark: #2e2e2c;
      --red: #8b1c1c; --mid: #6b6b68; --border: #ccc8c0;
    }
    body {
      background: var(--bg); color: var(--black); font-family: 'Lato', sans-serif;
      font-weight: 300; min-height: 100vh;
      background-image: url("image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    }
    body::before { content:''; display:block; height:3px; background:var(--red); position:fixed; top:0;left:0;right:0; z-index:999; }
    
    .back-nav {
      background: var(--bg2);
      padding: 12px 40px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 3px;
      z-index: 100;
    }
    
    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--black);
      text-decoration: none;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 8px 0;
      transition: color 0.2s;
    }
    .btn-back:hover { color: var(--red); }
    
    article {
      max-width: 720px;
      margin: 0 auto;
      padding: 60px 40px 80px;
    }
    
    .article-header {
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 2px solid var(--black);
    }
    
    .article-meta {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .article-category {
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--red);
    }
    
    .article-date {
      font-size: 0.7rem;
      font-weight: 400;
      color: var(--mid);
    }
    
    .article-title {
      font-family: 'Playfair Display', serif;
      font-size: 2.2rem;
      font-weight: 900;
      line-height: 1.2;
      color: var(--black);
      margin-bottom: 20px;
    }
    
    .article-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .tag {
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 4px 10px;
      background: var(--bg2);
      color: var(--mid);
      border: 1px solid var(--border);
    }
    
    .article-body {
      font-size: 1.05rem;
      line-height: 1.9;
      color: var(--dark);
      margin-bottom: 40px;
    }
    
    .article-body p {
      margin-bottom: 1.5em;
    }
    
    .article-files {
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid var(--border);
    }
    
    .files-title {
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--mid);
      margin-bottom: 20px;
    }
    
    .file-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: white;
      border: 1px solid var(--border);
      border-left: 3px solid var(--black);
      border-radius: 4px;
      transition: border-left-color 0.2s, box-shadow 0.2s;
    }
    
    .file-item:hover {
      border-left-color: var(--red);
      box-shadow: 2px 2px 12px rgba(0,0,0,0.08);
    }
    
    .file-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    
    .file-info {
      flex: 1;
    }
    
    .file-name {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--black);
      margin-bottom: 4px;
    }
    
    .file-type {
      font-size: 0.75rem;
      color: var(--mid);
    }
    
    .file-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .btn-view, .btn-download {
      text-decoration: none;
      padding: 10px 18px;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      border-radius: 4px;
      transition: all 0.2s;
      white-space: nowrap;
      cursor: pointer;
      border: none;
    }
    
    .btn-view {
      background: var(--bg2);
      color: var(--black);
      border: 1px solid var(--border);
    }
    
    .btn-view:hover {
      background: var(--border);
    }
    
    .btn-download {
      background: var(--black);
      color: white;
    }
    
    .btn-download:hover {
      background: var(--red);
    }
    
    /* Modal/Overlay para vista previa */
    .preview-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(20, 20, 18, 0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(4px);
    }
    
    .preview-overlay.active {
      display: flex;
    }
    
    .preview-container {
      background: white;
      width: 100%;
      max-width: 1000px;
      height: 90vh;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
    }
    
    .preview-title {
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--black);
    }
    
    .preview-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--mid);
      padding: 4px 8px;
      transition: color 0.2s;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .preview-close:hover {
      color: var(--black);
    }
    
    .preview-content {
      flex: 1;
      overflow: auto;
      background: var(--bg);
    }
    
    .preview-content iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .preview-content img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    
    .preview-not-supported {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 40px;
      text-align: center;
      color: var(--mid);
    }
    
    .preview-not-supported .icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }
    
    .preview-not-supported p {
      font-size: 1rem;
      margin-bottom: 20px;
    }
    
    .loading {
      text-align: center;
      padding: 80px 20px;
      font-size: 1rem;
      color: var(--mid);
    }
    
    .error {
      text-align: center;
      padding: 80px 20px;
      color: var(--red);
    }
    
    @media(max-width:580px){
      .back-nav{ padding:10px 16px; }
      .btn-back{ font-size:0.7rem; min-height:44px; display:inline-flex; align-items:center; }
      article{ padding:40px 16px 60px; }
      .article-header{ margin-bottom:30px; padding-bottom:20px; }
      .article-meta{ gap:12px; }
      .article-category{ font-size:0.65rem; }
      .article-date{ font-size:0.65rem; }
      .article-title{ font-size:1.6rem; line-height:1.3; }
      .article-tags{ gap:6px; }
      .tag{ padding:3px 8px; font-size:0.6rem; }
      .article-body{ font-size:1rem; line-height:1.8; }
      .article-files{ margin-top:30px; padding-top:20px; }
      .files-title{ font-size:0.7rem; margin-bottom:16px; }
      .file-item{ padding:14px; gap:10px; flex-wrap: wrap; }
      .file-icon{ font-size:1.3rem; }
      .file-name{ font-size:0.85rem; }
      .file-type{ font-size:0.7rem; }
      .file-actions{ width: 100%; margin-top: 10px; }
      .btn-view, .btn-download{ flex: 1; text-align: center; padding: 10px 14px; font-size: 0.65rem; }
      .preview-overlay{ padding: 0; }
      .preview-container{ height: 100vh; max-width: 100%; border-radius: 0; }
      .preview-header{ padding: 12px 16px; }
      .preview-title{ font-size: 0.75rem; }
      .preview-close{ min-width: 44px; min-height: 44px; }
    }
  </style>
</head>
<body>

<nav class="back-nav">
  <a href="index.html" class="btn-back">‚Üê Volver al inicio</a>
</nav>

<article id="article">
  <div class="loading">Cargando...</div>
</article>

<!-- Modal de Vista Previa -->
<div class="preview-overlay" id="previewOverlay" onclick="closePreview(event)">
  <div class="preview-container" onclick="event.stopPropagation()">
    <div class="preview-header">
      <div class="preview-title" id="previewTitle">Vista previa</div>
      <button class="preview-close" onclick="closePreview()">‚úï</button>
    </div>
    <div class="preview-content" id="previewContent">
      <!-- Contenido din√°mico -->
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD57cIHb-k4bhMwKvoDHp2uOcJw_EDPVxg",
    authDomain: "netnull-a9a18.firebaseapp.com",
    projectId: "netnull-a9a18",
    storageBucket: "netnull-a9a18.firebasestorage.app",
    messagingSenderId: "85420219235",
    appId: "1:85420219235:web:b7a93121caa8519602d156"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const LABELS = { 
    politica:'Pol√≠tica', 
    sociedad:'Sociedad', 
    economia:'Econom√≠a', 
    cultura:'Cultura', 
    historia:'Historia' 
  };

  function getFileIcon(filename) {
    if (!filename) return 'üìÑ';
    const lower = filename.toLowerCase();
    if (lower.includes('.pdf')) return 'üìï';
    if (lower.includes('.doc') || lower.includes('.txt')) return 'üìù';
    if (lower.includes('.xls') || lower.includes('.csv')) return 'üìä';
    if (lower.includes('.jpg') || lower.includes('.png') || lower.includes('.gif')) return 'üñºÔ∏è';
    if (lower.includes('.zip') || lower.includes('.rar')) return 'üì¶';
    return 'üìÑ';
  }

  function getFileType(filename) {
    if (!filename) return 'other';
    const lower = filename.toLowerCase();
    if (lower.includes('.pdf')) return 'pdf';
    if (lower.includes('.jpg') || lower.includes('.jpeg') || lower.includes('.png') || lower.includes('.gif') || lower.includes('.webp')) return 'image';
    if (lower.includes('.mp4') || lower.includes('.webm') || lower.includes('.ogg')) return 'video';
    return 'other';
  }

  window.openPreview = function(url, name, type) {
    const overlay = document.getElementById('previewOverlay');
    const content = document.getElementById('previewContent');
    const title = document.getElementById('previewTitle');
    
    title.textContent = name;
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    if (type === 'image') {
      content.innerHTML = `<img src="${url}" alt="${name}">`;
    } else if (type === 'pdf') {
      content.innerHTML = `<iframe src="${url}#toolbar=0" title="${name}"></iframe>`;
    } else if (type === 'video') {
      content.innerHTML = `
        <video controls style="width:100%; height:100%; background:#000;">
          <source src="${url}" type="video/mp4">
          Tu navegador no soporta la reproducci√≥n de video.
        </video>
      `;
    } else {
      content.innerHTML = `
        <div class="preview-not-supported">
          <div class="icon">üìÑ</div>
          <p>Este tipo de archivo no se puede visualizar directamente.</p>
          <a href="${url}" target="_blank" class="btn-download" style="display:inline-block;">Descargar archivo</a>
        </div>
      `;
    }
  };

  window.closePreview = function(event) {
    if (event && event.target !== event.currentTarget) return;
    
    const overlay = document.getElementById('previewOverlay');
    const content = document.getElementById('previewContent');
    
    overlay.classList.remove('active');
    content.innerHTML = '';
    document.body.style.overflow = '';
  };

  // Cerrar con tecla ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closePreview();
    }
  });

  async function loadIdea() {
    const urlParams = new URLSearchParams(window.location.search);
    const ideaId = urlParams.get('id');
    
    if (!ideaId) {
      document.getElementById('article').innerHTML = '<div class="error">Idea no encontrada</div>';
      return;
    }

    try {
      const docRef = doc(db, "ideas", ideaId);
      const docSnap = await getDoc(docRef);
      
      if (!docSnap.exists()) {
        document.getElementById('article').innerHTML = '<div class="error">Idea no encontrada</div>';
        return;
      }

      const idea = docSnap.data();
      
      const filesHTML = idea.files && idea.files.length > 0 ? `
        <div class="article-files">
          <div class="files-title">üìé Archivos adjuntos</div>
          <div class="file-list">
            ${idea.files.map(f => {
              const type = getFileType(f.name || f.url);
              const canView = type === 'image' || type === 'pdf' || type === 'video';
              
              return `
                <div class="file-item">
                  <div class="file-icon">${getFileIcon(f.name || f.url)}</div>
                  <div class="file-info">
                    <div class="file-name">${f.name || 'Archivo adjunto'}</div>
                    <div class="file-type">${(f.name || f.url).split('.').pop().toUpperCase()}</div>
                  </div>
                  <div class="file-actions">
                    ${canView ? `<button class="btn-view" onclick="openPreview('${f.url}', '${f.name || 'Archivo'}', '${type}')">üëÅÔ∏è Ver</button>` : ''}
                    <a href="${f.url}" target="_blank" class="btn-download">‚¨áÔ∏è Descargar</a>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      ` : '';

      document.getElementById('article').innerHTML = `
        <header class="article-header">
          <div class="article-meta">
            <span class="article-category">${LABELS[idea.section] || idea.section}</span>
            <span class="article-date">${idea.date}</span>
          </div>
          <h1 class="article-title">${idea.idea}</h1>
          ${idea.tags && idea.tags.length > 0 ? `
            <div class="article-tags">
              ${idea.tags.map(t => `<span class="tag">${t}</span>`).join('')}
            </div>
          ` : ''}
        </header>
        
        <div class="article-body">
          ${idea.body}
        </div>
        
        ${filesHTML}
      `;

      document.title = `${idea.idea} - Mis Ideas`;

    } catch (error) {
      console.error("Error cargando idea:", error);
      document.getElementById('article').innerHTML = '<div class="error">Error al cargar la idea</div>';
    }
  }

  loadIdea();
</script>

</body>
</html>